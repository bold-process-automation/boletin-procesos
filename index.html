
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boletín de Procesos | Bold</title>
  <link rel="icon" type="image/x-icon" href="favicon-bold.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%23121f6c'/><text x='16' y='22' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-weight='bold' font-size='14'>B</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bold-primary: #121f6c;     /* Azul principal Bold */
      --bold-secondary: #4d2864;   /* Morado corporativo */
      --bold-accent: #692e60;      /* Morado medio */
      --bold-coral: #9c3559;       /* Coral corporativo */
      --bold-red: #bf3b51;         /* Rojo Bold */
      --bold-bright: #ee424e;      /* Rojo vibrante */
      --bold-success: #22c55e;     /* Verde éxito */
      --bold-warning: #f59e0b;     /* Amarillo advertencia */
      --bold-error: #891618;       /* Granate error */
      --bold-gradient-primary: linear-gradient(135deg, #121f6c 0%, #4d2864 100%);
      --bold-gradient-accent: linear-gradient(135deg, #692e60 0%, #9c3559 100%);
      --bold-text-dark: #1f2937;
      --bold-text-light: #6b7280;
      --bold-bg-light: #f8fafc;
    }
    
    * { font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif; }
    html { scroll-behavior: smooth; }
    body { 
      background: var(--bold-bg-light);
      color: var(--bold-text-dark);
      line-height: 1.6;
    }
    
    .fade-in{animation:fade .4s ease-out both}
    @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .bar{transition:width .4s ease}
    
    /* Navegación profesional */
    .nav-btn{
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      font-weight: 500;
      font-size: 0.95rem;
      letter-spacing: -0.025em;
    }
    .nav-btn:hover{
      background: var(--bold-gradient-primary) !important; 
      color: white !important; 
      transform: translateY(-1px); 
      box-shadow: 0 6px 20px rgba(18, 31, 108, 0.25);
      border-color: transparent !important;
    }
    .nav-btn:active{transform:translateY(0px);}
    
    /* Clases de colores */
    .bold-gradient-primary { background: var(--bold-gradient-primary); }
    .bold-gradient-accent { background: var(--bold-gradient-accent); }
    .bold-primary { color: var(--bold-primary); }
    .bold-secondary { color: var(--bold-secondary); }
    .bold-accent { color: var(--bold-accent); }
    .bold-coral { color: var(--bold-coral); }
    .bold-red { color: var(--bold-red); }
    .bold-bright { color: var(--bold-bright); }
    .bold-success { color: var(--bold-success); }
    .bold-warning { color: var(--bold-warning); }
    .bold-error { color: var(--bold-error); }
    
    /* Header de tabla profesional */
    th.sticky{
      position:sticky;
      top:0;
      background: var(--bold-primary);
      color:#fff; 
      font-weight: 600;
      font-size: 0.875rem;
      letter-spacing: 0.025em;
      text-transform: uppercase;
    }
    
    /* Tarjetas corporativas */
    .card-shadow { 
      box-shadow: 0 2px 8px rgba(18, 31, 108, 0.08), 0 0 1px rgba(18, 31, 108, 0.12); 
      border: 1px solid rgba(18, 31, 108, 0.06);
    }
    .card-shadow:hover { 
      box-shadow: 0 8px 32px rgba(18, 31, 108, 0.16), 0 2px 8px rgba(18, 31, 108, 0.08); 
      transform: translateY(-2px); 
      border-color: rgba(18, 31, 108, 0.12);
    }
    
    /* Botón principal corporativo */
    .bold-button {
      background: var(--bold-gradient-accent);
      color: white;
      font-weight: 600;
      border-radius: 10px;
      padding: 12px 24px;
      border: none;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 0.9rem;
      letter-spacing: -0.025em;
    }
    .bold-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(156, 53, 89, 0.3);
      filter: brightness(1.05);
    }
    
    /* Tipografía profesional */
    .heading-primary {
      font-weight: 800;
      letter-spacing: -0.03em;
      line-height: 1.1;
    }
    .heading-secondary {
      font-weight: 700;
      letter-spacing: -0.025em;
      line-height: 1.2;
    }
    .text-corporate {
      font-weight: 500;
      color: var(--bold-text-light);
      line-height: 1.6;
    }
    
    /* Utilidades para tarjetas estilo Bold.co */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    /* Animaciones para botones del hero */
    .hero-nav-btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform, box-shadow;
    }
    
    /* Navegación sticky con animación suave */
    .sticky-nav-btn {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform, box-shadow;
    }
    
    /* Mejoras de smooth scroll */
    html {
      scroll-padding-top: 100px;
    }
    
    /* Navegación lateral */
    #sideNav {
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateX(-80px) translateY(-50%); /* Sale más de la pantalla */
    }
    
    #sideNav.show {
      opacity: 1;
      pointer-events: all;
      transform: translateX(0) translateY(-50%);
    }
    
    /* Contenedor de la barra que se expande */
    .side-nav-container {
      width: 60px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      position: relative;
    }
    
    .side-nav-container:hover {
      width: 240px;
      background: white !important;
      color: #121E6C;
    }
    
    .side-nav-item {
      position: relative;
      border-radius: 0;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding-left: 16px;
      padding-right: 16px;
      transition: all 0.3s ease;
      color: white;
    }
    
    .side-nav-container:hover .side-nav-item {
      color: #121E6C;
    }
    
    .side-nav-container:hover .side-nav-item:hover {
      background-color: rgba(18, 30, 108, 0.1) !important;
    }
    
    /* Texto que aparece en hover */
    .side-nav-text {
      margin-left: 12px;
      white-space: nowrap;
      opacity: 0;
      transform: translateX(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
      font-size: 14px;
      color: inherit;
    }
    
    .side-nav-container:hover .side-nav-text {
      opacity: 1;
      transform: translateX(0);
    }
    
    /* Centrar iconos cuando no hay hover */
    .side-nav-icon {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      color: inherit;
    }
    
    /* Filtro para convertir iconos PNG a blanco cuando está contraído */
    .side-nav-icon img {
      transition: filter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      filter: brightness(0) invert(1); /* Convierte a blanco */
    }
    
    /* Restaurar colores originales cuando la barra está expandida */
    .side-nav-container:hover .side-nav-icon img {
      filter: none; /* Colores originales */
    }
    
    /* Selector de fechas flotante derecho */
    #dateNav {
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateX(80px) translateY(-50%); /* Sale más de la pantalla */
    }
    
    #dateNav.show {
      opacity: 1;
      pointer-events: all;
      transform: translateX(0) translateY(-50%);
    }
    
    /* Panel expandible en hover */
    #dateNav:hover .floating-panel {
      opacity: 1;
      transform: translateX(0);
      pointer-events: all;
    }
    
    /* Botón flotante efectos */
    #floatingMonthSelector:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(255, 41, 71, 0.3);
    }
    
    /* Opciones del panel flotante */
    .floating-month-option {
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
    }
    
    .floating-month-option:hover {
      background-color: rgba(255, 41, 71, 0.1);
      color: #FF2947;
      font-weight: 600;
    }
    
    .floating-month-option.active {
      background-color: #FF2947;
      color: white;
      font-weight: 600;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      #sideNav, #dateNav {
        display: none;
      }
    }
    
    /* Checkboxes personalizados para filtros - usando imágenes personalizadas */
    #filterDropdown input[type="checkbox"] {
      width: 16px !important;
      height: 16px !important;
      min-width: 16px;
      min-height: 16px;
      max-width: 16px;
      max-height: 16px;
      border: none;
      background-color: transparent;
      cursor: pointer;
      position: relative;
      margin: 0;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url('uncheckbox-icon.png');
      background-size: 16px 16px;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    /* Checkbox seleccionado - usar imagen checkbox-icon */
    #filterDropdown input[type="checkbox"]:checked {
      background-image: url('checkbox-icon.png');
      background-size: 16px 16px;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    /* Texto de las opciones del filtro en azul Bold */
    #filterDropdown .filter-option {
      color: #121E6C;
      font-weight: 500;
    }
    
    /* Hover effect para las opciones */
    #filterDropdown .filter-option:hover {
      background-color: rgba(18, 30, 108, 0.05);
      border-radius: 4px;
    }
    
    /* Botón volver arriba - efecto hover similar a la barra lateral */
    .scroll-to-top-btn {
      transition: all 0.3s ease;
    }
    
    .scroll-to-top-btn:hover {
      width: auto;
      min-width: 120px;
      border-radius: 28px;
    }
    
    .scroll-to-top-btn:hover .scroll-to-top-icon {
      opacity: 0;
      transform: translateX(-100%);
    }
    
    .scroll-to-top-btn:hover .scroll-to-top-text {
      opacity: 1;
      transform: translateX(0);
    }
    
    .scroll-to-top-btn .scroll-to-top-text {
      padding: 0 20px;
    }
    
  </style>
  
  <!-- Google Sign-In Library -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <!-- Google Sheets Connector -->
  <script src="sheets-connector.js"></script>
  
  <!-- Authentication Module -->
  <script src="auth.js"></script>
</head>
<body class="min-h-screen">
  
  <!-- Login Screen (shown before authentication) -->
  <div id="loginScreen" style="display: none; justify-content: center; align-items: center; min-height: 100vh; background: var(--bold-gradient-primary);">
    <div style="text-align: center; max-width: 500px; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(18, 31, 108, 0.3);">
      <!-- Logo Bold -->
      <div style="margin-bottom: 32px;">
        <img src="bold-logo-cf.png" alt="Bold Logo" style="height: 60px; margin: 0 auto;" onerror="this.style.display='none'" />
      </div>
      
      <!-- Título -->
      <h1 style="font-size: 32px; font-weight: 800; color: var(--bold-primary); margin-bottom: 16px; letter-spacing: -0.03em;">
        Boletín de Procesos
      </h1>
      
      <p style="font-size: 16px; color: var(--bold-text-light); margin-bottom: 40px; line-height: 1.6;">
        Ingresa con tu cuenta corporativa de Bold para acceder al boletín de procesos y automatizaciones.
      </p>
      
      <!-- Google Sign-In Button Container -->
      <div id="googleSignInButton" style="display: flex; justify-content: center; margin-bottom: 20px;"></div>
      
      <!-- Access Denied Message (hidden by default) -->
      <div id="accessDenied" style="display: none; margin-top: 20px;"></div>
      
      <!-- Footer info -->
      <div style="margin-top: 32px; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <svg style="width: 16px; height: 16px; color: #6b7280;" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
        </svg>
        <p style="font-size: 13px; color: #6b7280; margin: 0; font-weight: 500;">
          Solo miembros de la organización
        </p>
      </div>
    </div>
  </div>
  
  <!-- Loading Skeleton (shown while checking auth) -->
  <div id="loadingSkeleton" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: var(--bold-bg-light);">
    <div style="text-align: center;">
      <div style="width: 60px; height: 60px; border: 4px solid #e5e7eb; border-top-color: #121E6C; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px;"></div>
      <p style="color: #121E6C; font-weight: 600; font-size: 16px;">Cargando boletín...</p>
    </div>
  </div>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
  
  <!-- Main Content (hidden until authenticated) -->
  <div id="mainContent" style="display: none;">
  <!-- Hero Section estilo Bold.co -->
  <div class="relative min-h-screen overflow-hidden">
    <!-- Fondo con imagen corporativa -->
    <div class="absolute inset-0" style="background-image: url('header-bold.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat;"></div>
    <!-- Overlay opcional para mejorar legibilidad del texto -->
    <div class="absolute inset-0 bg-black/10"></div>
    <!-- Header actualizado con design system Bold -->
    
    <!-- Contenido principal -->
    <div class="relative flex items-end min-h-screen">
      <div class="w-full px-8 md:px-16 py-20">
        <div class="flex items-end justify-between w-full">
          <!-- Columna izquierda: Contenido (esquina inferior izquierda) -->
          <div class="w-1/2 pl-4 lg:pl-8 space-y-8 text-left">
            <!-- Etiqueta superior -->
            <div class="mb-8">
              <span class="text-white text-xl font-semibold tracking-wide uppercase">Arquitectura de Negocio y Automatización</span>
            </div>
            
            <!-- Título principal -->
            <div class="space-y-8">
              <h1 class="text-5xl md:text-6xl lg:text-7xl xl:text-8xl font-black leading-tight text-white">
                Boletín de Procesos
              </h1>
              
              <p class="text-xl md:text-2xl leading-relaxed text-white/90 max-w-xl">
                Información actualizada sobre cambios, automatizaciones y mejoras continuas en Bold CF y Bold.co SAS
              </p>
            </div>
          </div>
          
          <!-- Columna derecha: Botones (esquina inferior derecha) -->
          <div class="w-1/2 flex justify-end items-end pr-4 lg:pr-8">
            <div id="heroNavButtons" class="flex flex-col gap-4 w-full max-w-sm">
              <a href="#cambios" class="hero-nav-btn group bg-white hover:bg-gray-50 rounded-full px-8 py-4 font-bold text-lg shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105 w-full">
                <div class="flex items-center justify-center">
                  <span class="text-[#121E6C]">Procesos</span>
                </div>
              </a>
              
              <a href="#valor-agregado" class="hero-nav-btn group bg-white hover:bg-gray-50 rounded-full px-8 py-4 font-bold text-lg shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105 w-full">
                <div class="flex items-center justify-center">
                  <span class="text-[#121E6C]">Valor Agregado</span>
                </div>
              </a>
              
              <a href="#automatizaciones" class="hero-nav-btn group bg-white hover:bg-gray-50 rounded-full px-8 py-4 font-bold text-lg shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105 w-full">
                <div class="flex items-center justify-center">
                  <span class="text-[#121E6C]">Automatización</span>
                </div>
              </a>
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Navegación sticky (oculta ya que usamos la lateral) -->
  <nav id="stickyNav" class="hidden">
  </nav>
  
  <div class="mx-auto max-w-7xl p-6 md:p-12">


    <!-- ========== CAMBIOS (LISTADO) ========== -->
    <section id="cambios" class="mt-24 scroll-mt-8">
      <!-- Header estilo consistente con las otras secciones -->
      <div class="mb-16 px-6 md:px-12">
            <h2 class="text-4xl md:text-5xl lg:text-6xl font-black leading-none mb-8 text-left">
              <span style="color: #121E6C;">
                Gestión de Procesos
              </span>
            </h2>
          
          <p class="text-lg md:text-xl leading-relaxed mb-8" style="color: #606060; text-align: justify; max-width: 100%;">
            A continuación podrás consultar el registro y seguimiento detallado de creaciones, actualizaciones y modificaciones en los procesos organizacionales de Bold CF y Bold.co SAS.
          </p>
      </div>
      <!-- Barra de búsqueda sencilla -->
      <div class="mb-8 px-6 md:px-12">
        <div class="flex items-center gap-4">
          <div class="flex-1 relative">
            <input id="q2" type="text" placeholder="Buscar" class="pl-12 w-full rounded-full h-12 px-6 text-base outline-none text-gray-600 bg-white" style="font-family: 'Montserrat', sans-serif;" />
            <!-- Icono de búsqueda del design system Bold -->
            <img src="lupa-bold.png" alt="Buscar" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 opacity-60">
          </div>
          <button id="resetBtn2" class="bg-white rounded-full px-6 py-3 h-12 whitespace-nowrap font-semibold transition-all hover:shadow-md" style="font-family: 'Montserrat', sans-serif; color: #121E6C;">
            ↻ Limpiar filtros
          </button>
        </div>
      </div>
      
      <!-- Paginación y contador arriba de la tabla -->
      <div class="flex items-center justify-between mt-4 mb-2 text-sm text-slate-600 px-6 md:px-12">
        <div id="countCambios" class="font-medium">0 resultados</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="rounded-lg border px-3 py-2 bg-white border-slate-300 hover:bg-slate-50 font-medium transition-colors" style="color: #121E6C;">«</button>
          <div id="pageInfo" class="flex items-center gap-1">
            <!-- Páginas generadas dinámicamente -->
          </div>
          <button id="nextPage" class="rounded-lg border px-3 py-2 bg-white border-slate-300 hover:bg-slate-50 font-medium transition-colors" style="color: #121E6C;">»</button>
        </div>
      </div>
      
      <div class="overflow-x-auto rounded-2xl mx-6 md:mx-12">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-white" style="background-color: white !important;">
              <th class="sticky px-3 py-2 text-left w-32" style="background-color: white !important;">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-bold" style="color: #121E6C;">Código</span>
                  <button class="filter-btn hover:opacity-80" style="color: #121E6C;" data-column="codigo" onclick="showFilterDropdown('codigo', event)">
                    <svg class="w-3 h-3" viewBox="0 0 12 12" fill="currentColor">
                      <path d="M0 0h12l-5 6v4l-2 2v-6l-5-6z"/>
                    </svg>
                  </button>
                </div>
              </th>
              <th class="sticky px-3 py-2 text-left" style="background-color: white !important;">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-bold" style="color: #121E6C;">Documento</span>
                  <button class="filter-btn hover:opacity-80" style="color: #121E6C;" data-column="documento" onclick="showFilterDropdown('documento', event)">
                    <svg class="w-3 h-3" viewBox="0 0 12 12" fill="currentColor">
                      <path d="M0 0h12l-5 6v4l-2 2v-6l-5-6z"/>
                    </svg>
                  </button>
                </div>
              </th>
              <th class="sticky px-3 py-2 text-left w-48" style="background-color: white !important;">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-bold" style="color: #121E6C;">Dueño</span>
                  <button class="filter-btn hover:opacity-80" style="color: #121E6C;" data-column="dueno" onclick="showFilterDropdown('dueno', event)">
                    <svg class="w-3 h-3" viewBox="0 0 12 12" fill="currentColor">
                      <path d="M0 0h12l-5 6v4l-2 2v-6l-5-6z"/>
                    </svg>
                  </button>
                </div>
              </th>
              <th class="sticky px-3 py-2 text-left" style="background-color: white !important;">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-bold" style="color: #121E6C;">Detalle</span>
                  <button class="filter-btn hover:opacity-80" style="color: #121E6C;" data-column="detalle" onclick="showFilterDropdown('detalle', event)">
                    <svg class="w-3 h-3" viewBox="0 0 12 12" fill="currentColor">
                      <path d="M0 0h12l-5 6v4l-2 2v-6l-5-6z"/>
                    </svg>
                  </button>
                </div>
              </th>
              <th class="sticky px-3 py-2 text-left w-20" style="background-color: white !important;">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-bold" style="color: #121E6C;">Compañía</span>
                  <button class="filter-btn hover:opacity-80" style="color: #121E6C;" data-column="compania" onclick="showFilterDropdown('compania', event)">
                    <svg class="w-3 h-3" viewBox="0 0 12 12" fill="currentColor">
                      <path d="M0 0h12l-5 6v4l-2 2v-6l-5-6z"/>
                    </svg>
                  </button>
                </div>
              </th>
              <th class="sticky px-3 py-2 text-left w-32" style="background-color: white !important;">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-bold" style="color: #121E6C;">Tipo</span>
                  <button class="filter-btn hover:opacity-80" style="color: #121E6C;" data-column="tipo" onclick="showFilterDropdown('tipo', event)">
                    <svg class="w-3 h-3" viewBox="0 0 12 12" fill="currentColor">
                      <path d="M0 0h12l-5 6v4l-2 2v-6l-5-6z"/>
                    </svg>
                  </button>
                </div>
              </th>
              <th class="sticky px-3 py-2 text-left w-28" style="background-color: white !important;">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-bold" style="color: #121E6C;">Fecha</span>
                  <button class="filter-btn hover:opacity-80" style="color: #121E6C;" data-column="fecha" onclick="showFilterDropdown('fecha', event)">
                    <svg class="w-3 h-3" viewBox="0 0 12 12" fill="currentColor">
                      <path d="M0 0h12l-5 6v4l-2 2v-6l-5-6z"/>
                    </svg>
                  </button>
                </div>
              </th>
              <th class="sticky px-3 py-2 text-left w-20" style="background-color: white !important;">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-bold" style="color: #121E6C;">VA</span>
                  <button class="filter-btn hover:opacity-80" style="color: #121E6C;" data-column="va" onclick="showFilterDropdown('va', event)">
                    <svg class="w-3 h-3" viewBox="0 0 12 12" fill="currentColor">
                      <path d="M0 0h12l-5 6v4l-2 2v-6l-5-6z"/>
                    </svg>
                  </button>
                </div>
              </th>
            </tr>
          </thead>
          <tbody id="tbodyCambios" class="bg-white"></tbody>
        </table>
      </div>
      
      <!-- Mensaje de no resultados para Gestión de Procesos -->
      <div id="noResultsCambios" class="hidden bg-gray-50 rounded-2xl p-8 text-center mx-6 md:mx-12">
        <div class="flex items-center justify-center mb-4">
          <img src="unfound-icon.png" alt="No encontrado" class="w-12 h-12 opacity-60">
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No hay resultados</h3>
        <p id="noResultsTextCambios" class="text-gray-600">No se encontraron procesos que coincidan con tu búsqueda.</p>
      </div>
      
      <!-- Dropdown de filtro estilo Google Sheets -->
      <div id="filterDropdown" class="hidden fixed bg-white border border-gray-300 rounded-lg shadow-lg z-50 w-64">
        <div class="p-3">
          <!-- Opciones de ordenamiento -->
          <div class="border-b pb-2 mb-2">
            <button onclick="applySortFilter('asc')" class="w-full text-left px-2 py-1 hover:bg-gray-100 rounded text-sm flex items-center gap-2">
              <span>↑</span> Ordenar A → Z
            </button>
            <button onclick="applySortFilter('desc')" class="w-full text-left px-2 py-1 hover:bg-gray-100 rounded text-sm flex items-center gap-2">
              <span>↓</span> Ordenar Z → A
            </button>
          </div>
          
          <!-- Filtros -->
          <div class="mb-2">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium">Filtrar por:</span>
              <button onclick="clearColumnFilter()" class="text-xs hover:opacity-80" style="color: #FF2947;">Limpiar</button>
            </div>
            
            <!-- Buscar dentro de la columna -->
            <div class="mb-2">
              <input id="columnSearch" type="text" placeholder="Buscar..." class="w-full text-xs border border-gray-300 rounded px-2 py-1">
            </div>
            
            <!-- Checkboxes de selección -->
            <div class="max-h-48 overflow-y-auto">
              <label class="flex items-center gap-2 px-2 py-1 hover:bg-gray-50 text-sm">
                <input type="checkbox" id="selectAll" onchange="toggleAllFilters()" checked>
                <span class="font-medium">(Seleccionar todo)</span>
              </label>
              <div id="filterOptions" class="border-t pt-1 mt-1">
                <!-- Opciones dinámicas se cargarán aquí -->
              </div>
            </div>
          </div>
          
          <!-- Botones de acción -->
          <div class="flex gap-2 pt-2 border-t">
            <button onclick="applyColumnFilter()" class="flex-1 text-white px-3 py-1 rounded text-sm hover:opacity-90" style="background-color: #121E6C;">OK</button>
            <button onclick="hideFilterDropdown()" class="flex-1 bg-gray-200 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-300">Cancelar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== VALOR AGREGADO POR UNIDAD DE NEGOCIO ========== -->
    <section id="valor-agregado" class="mt-24 scroll-mt-32">
      <!-- Sección expandida a ancho completo -->
      <div class="w-full">
        <!-- Título alineado a la izquierda -->
        <div class="mb-16 max-w-7xl mx-auto px-6 md:px-12">
            <h2 class="text-4xl md:text-5xl lg:text-6xl font-black leading-none mb-8 text-left">
              <span style="color: #121E6C;">
                Valor Agregado
              </span>
            </h2>
            <p class="text-lg md:text-xl leading-relaxed mb-6" style="color: #606060; text-align: justify;">
              Las actividades que agregan valor son aquellas completamente automatizadas o que no pueden automatizarse debido a que requieren intervención del intelecto humano para su ejecución. Las demás actividades no agregan valor y requieren iniciativas de automatización.
            </p>
            <p class="text-lg md:text-xl leading-relaxed mb-6" style="color: #606060; text-align: justify;">
              El porcentaje indica cuánto valor agregado tiene cada proceso comparando el total de actividades contra las que sí agregan valor. Un porcentaje menor significa mayor oportunidad de automatización.
            </p>
            <p class="text-lg md:text-xl leading-relaxed" style="color: #606060; text-align: justify;">
              Aunque no todos los procesos pueden llegar al 100%, se recomienda implementar estrategias para alcanzar al menos el 80% de valor agregado.
            </p>
        </div>
        
        <!-- Grid de tarjetas expandido -->
        <div id="valueAddedCards" class="max-w-7xl mx-auto px-6 md:px-12">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            <!-- Tarjeta SAS -->
            <div class="bg-white rounded-3xl card-shadow overflow-hidden hover:shadow-xl transition-all duration-300 h-[450px]">
              <!-- Header estilo Bold.co -->
              <div class="p-6" style="background: linear-gradient(to right, #121E6C, #EE424E);">
                <div class="flex items-center gap-4">
                  <img src="datafono-bold.png" alt="Datáfono Bold" class="w-12 h-12 object-contain">
                <div>
                  <h3 class="text-lg font-bold text-white">Bold.co SAS</h3>
                  <p class="text-white/90 text-sm">Valor agregado por unidad de negocio</p>
                </div>
                </div>
              </div>
              
              <!-- Contenido del gráfico -->
              <div class="p-6 flex-1">
                <div class="bg-gradient-to-br from-gray-50 to-white p-4 rounded-2xl border border-gray-100 h-full shadow-inner">
                  <img id="img1" alt="Valor agregado SAS" class="w-full h-full object-contain rounded-xl cursor-zoom-in hover:scale-[1.02] transition-transform duration-300">
                </div>
              </div>
            </div>
            
            <!-- Tarjeta CF -->
            <div class="bg-white rounded-3xl card-shadow overflow-hidden hover:shadow-xl transition-all duration-300 h-[450px]">
              <!-- Header estilo Bold.co -->
              <div class="p-6" style="background: linear-gradient(to right, #121E6C, #1E23A2);">
                <div class="flex items-center gap-4">
                  <img src="banco-bold.png" alt="Banco Bold" class="w-12 h-12 object-contain">
                <div>
                  <h3 class="text-lg font-bold text-white">Bold CF</h3>
                  <p class="text-white/90 text-sm">Valor agregado por unidad de negocio</p>
                </div>
                </div>
              </div>
              
              <!-- Contenido del gráfico -->
              <div class="p-6 flex-1">
                <div class="bg-gradient-to-br from-gray-50 to-white p-4 rounded-2xl border border-gray-100 h-full shadow-inner">
                  <img id="img2" alt="Valor agregado CF" class="w-full h-full object-contain rounded-xl cursor-zoom-in hover:scale-[1.02] transition-transform duration-300">
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Mensaje de no resultados para Valor Agregado -->
        <div id="noResultsValueAdded" class="hidden max-w-7xl mx-auto px-6 md:px-12">
          <div class="bg-gray-50 rounded-2xl p-8 text-center">
            <div class="flex items-center justify-center mb-4">
              <img src="unfound-icon.png" alt="No encontrado" class="w-12 h-12 opacity-60">
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No hay datos disponibles</h3>
            <p id="noResultsTextValueAdded" class="text-gray-600">No hay imágenes de valor agregado disponibles para este período.</p>
          </div>
        </div>
      </div>

      <!-- Modal/lightbox para ampliar -->
      <div id="lightbox" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
        <img id="lightboxImg" class="max-h-[90vh] max-w-[95vw] rounded-xl shadow-2xl">
      </div>
    </section>

    <!-- ========== AUTOMATIZACIONES (TARJETAS) ========== -->
    <section id="automatizaciones" class="mt-24 scroll-mt-32">
      <!-- Header estilo de las imágenes con tipografía moderna -->
      <div class="mb-16 px-6 md:px-12">
          <h2 class="text-4xl md:text-5xl lg:text-6xl font-black leading-none mb-8 text-left">
            <span style="color: #121E6C;">
              Automatización
            </span>
          </h2>
          
          <p class="text-lg md:text-xl leading-relaxed mb-8" style="color: #606060; text-align: justify; max-width: 100%;">
            En esta sección, podrás consultar las aplicaciones de automatización en producción por el equipo de automatización de procesos.

Cada tarjeta incluye una descripción detallada de la automatización, el valor agregado que aporta al proceso y cómo su implementación contribuye a la eficiencia.
          </p>
      </div>
      
      <!-- Controles sin contenedor, en el aire -->
      <div class="mb-8 px-6 md:px-12">
        <!-- Búsqueda principal con botón de limpiar -->
        <div class="mb-6">
          <div class="flex items-center gap-4">
            <div class="flex-1 relative">
              <input id="q" type="text" placeholder="Buscar" class="pl-12 w-full rounded-full h-12 px-6 text-base outline-none text-gray-600 bg-white" style="font-family: 'Montserrat', sans-serif;" />
              <img src="lupa-bold.png" alt="Buscar" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 opacity-60">
            </div>
            <button id="resetBtn" class="bg-white rounded-full px-6 py-3 h-12 whitespace-nowrap font-semibold transition-all hover:shadow-md" style="font-family: 'Montserrat', sans-serif; color: #121E6C;">
              ↻ Limpiar filtros
            </button>
          </div>
        </div>
        
      </div>
      
      <!-- Grid de tarjetas -->
      <div id="cards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 px-6 md:px-12"></div>
      
      <!-- Mensaje de no resultados para Automatización -->
      <div id="noResultsAuto" class="hidden bg-gray-50 rounded-2xl p-8 text-center mx-6 md:mx-12">
        <div class="flex items-center justify-center mb-4">
          <img src="unfound-icon.png" alt="No encontrado" class="w-12 h-12 opacity-60">
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No hay resultados</h3>
        <p id="noResultsTextAuto" class="text-gray-600">No se encontraron automatizaciones que coincidan con tu búsqueda.</p>
      </div>
    </section>

    <!-- ========== FOOTER ESPACIADO ========== -->
    <footer class="mt-32 py-16">
      <div class="text-center">
        <div class="w-16 h-1 bg-gradient-to-r from-[#121E6C] to-[#1E23A2] rounded-full mx-auto mb-6"></div>
        <p class="text-sm text-gray-500 font-medium">
          Arquitectura de Negocio y Automatización | Bold.co
        </p>
      </div>
    </footer>

  </div>
  
  <!-- ========== COMPONENTE FLOTANTE SELECTOR MES/AÑO ========== -->
  <div id="floatMonthSelector" class="fixed top-20 right-8 z-40 opacity-0 pointer-events-none transform translate-x-full transition-all duration-500 ease-in-out">
    <!-- Botón principal del selector flotante -->
    <button id="floatMonthSelectorBtn" class="bg-white hover:bg-gray-50 rounded-full px-6 py-3 font-bold text-base shadow-xl hover:shadow-2xl transition-all duration-300 flex items-center gap-3 border border-gray-200 min-w-[180px] justify-center group">
      <img src="calendar-icon.png" alt="Calendario" class="w-5 h-5 opacity-80">
      <span id="floatSelectedMonth" class="text-[#121E6C]">Septiembre 2025</span>
      <svg id="floatMonthDropdownIcon" class="w-4 h-4 transition-transform duration-200 group-hover:rotate-180" fill="#121E6C" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </button>
    
    <!-- Dropdown flotante -->
    <div id="floatMonthDropdown" class="hidden absolute top-full right-0 mt-3 bg-white rounded-2xl shadow-2xl border border-gray-200 z-50 p-6 min-w-[400px]">
      <div class="text-center mb-4">
        <h3 class="text-lg font-bold" style="color: #121E6C;">Seleccionar período</h3>
      </div>
      
      <div class="grid grid-cols-2 gap-6">
        <!-- Selector de Año personalizado -->
        <div>
          <label class="block text-sm font-semibold mb-3" style="color: #121E6C;">Año</label>
          <div class="relative">
            <button id="floatYearSelectBtn" class="w-full px-4 py-3 rounded-2xl border border-gray-300 text-gray-700 font-bold text-left transition-all duration-200 hover:border-blue-400 hover:shadow-md focus:border-blue-500 focus:outline-none cursor-pointer flex items-center justify-between">
              <span id="floatYearSelectedText">2025</span>
              <svg class="w-4 h-4 text-gray-500 transition-transform duration-200" id="floatYearDropIcon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
            
            <!-- Dropdown personalizado de años -->
            <div id="floatYearDropdown" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-2xl shadow-xl border border-gray-200 z-50 overflow-hidden">
              <div id="floatYearOptions" class="py-2">
                <!-- Opciones generadas dinámicamente -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Selector de Mes personalizado -->
        <div>
          <label class="block text-sm font-semibold mb-3" style="color: #121E6C;">Mes</label>
          <div class="relative">
            <button id="floatMonthSelectBtn" class="w-full px-4 py-3 rounded-2xl border border-gray-300 text-gray-700 font-bold text-left transition-all duration-200 hover:border-blue-400 hover:shadow-md focus:border-blue-500 focus:outline-none cursor-pointer flex items-center justify-between">
              <span id="floatMonthSelectedText">Septiembre</span>
              <svg class="w-4 h-4 text-gray-500 transition-transform duration-200" id="floatMonthDropIcon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
              </svg>
            </button>
            
            <!-- Dropdown personalizado de meses -->
            <div id="floatMonthDropdownCustom" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-2xl shadow-xl border border-gray-200 z-50 overflow-hidden">
              <div id="floatMonthOptions" class="py-2">
                <!-- Opciones generadas dinámicamente -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Botón de aplicar obligatorio -->
      <div class="mt-6 text-center">
        <button id="confirmSelectionBtn" class="bg-gradient-to-r from-[#121E6C] to-[#1E23A2] text-white font-bold px-8 py-3 rounded-full hover:shadow-lg transition-all duration-300 hover:scale-105">
          ✓ Aplicar Selección
        </button>
      </div>
    </div>
  </div>
  
  <!-- Botón flotante volver arriba (visible solo en scroll) con efecto hover -->
  <button id="scrollToTopFloat" onclick="scrollToTop()" class="scroll-to-top-btn fixed bottom-8 right-8 text-white w-14 h-14 rounded-full shadow-2xl hover:scale-110 transition-all duration-300 z-50 opacity-0 pointer-events-none overflow-hidden" style="background-color: #121E6C;">
    <!-- Icono -->
    <div class="scroll-to-top-icon flex items-center justify-center w-full h-full transition-all duration-300">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
      </svg>
    </div>
    <!-- Texto que aparece en hover -->
    <span class="scroll-to-top-text absolute inset-0 flex items-center justify-center text-xs font-semibold whitespace-nowrap opacity-0 transform translate-x-full transition-all duration-300">Volver arriba</span>
  </button>

  <!-- Navegación lateral izquierda -->
  <nav id="sideNav" class="fixed left-4 top-1/2 -translate-y-1/2 z-40 opacity-0 pointer-events-none transition-all duration-500 ease-in-out">
    <div class="side-nav-container rounded-2xl shadow-2xl overflow-hidden" style="background: linear-gradient(to bottom, #121E6C, #1E23A2);">
      <!-- Icono Home (scroll to top) -->
      <a href="#" onclick="scrollToTop()" class="side-nav-item py-6 text-white hover:bg-white/20 transition-all duration-300">
        <div class="side-nav-icon">
          <img src="icon-home.png" alt="Inicio" class="w-6 h-6 object-contain">
        </div>
        <span class="side-nav-text">Inicio</span>
      </a>
      
      <!-- Procesos -->
      <a href="#cambios" class="side-nav-item py-6 text-white hover:bg-white/20 transition-all duration-300">
        <div class="side-nav-icon">
          <img src="icon-process.png" alt="Procesos" class="w-6 h-6 object-contain">
        </div>
        <span class="side-nav-text">Gestión de Procesos</span>
      </a>
      
      <!-- Valor Agregado -->
      <a href="#valor-agregado" class="side-nav-item py-6 text-white hover:bg-white/20 transition-all duration-300">
        <div class="side-nav-icon">
          <img src="icon-va.png" alt="Valor Agregado" class="w-6 h-6 object-contain">
        </div>
        <span class="side-nav-text">Valor Agregado</span>
      </a>
      
      <!-- Automatización -->
      <a href="#automatizaciones" class="side-nav-item py-6 text-white hover:bg-white/20 transition-all duration-300">
        <div class="side-nav-icon">
          <img src="icon-auto.png" alt="Automatización" class="w-6 h-6 object-contain">
        </div>
        <span class="side-nav-text">Automatización</span>
      </a>
    </div>
  </nav>
  

<script>
  // Función mejorada para parsear fechas en múltiples formatos
  function parseLocalDate(dateStr) {
    if (!dateStr) return new Date(1970, 0, 1);
    
    const str = String(dateStr).trim();
    
    // Formato YYYY-MM-DD o YYYY/MM/DD
    if (str.match(/^\d{4}[-\/]\d{1,2}[-\/]\d{1,2}$/)) {
      const parts = str.split(/[-\/]/).map(Number);
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }
    
    // Formato DD/MM/YYYY o DD-MM-YYYY
    if (str.match(/^\d{1,2}[-\/]\d{1,2}[-\/]\d{4}$/)) {
      const parts = str.split(/[-\/]/).map(Number);
      return new Date(parts[2], parts[1] - 1, parts[0]);
    }
    
    // Intentar parsear como timestamp o fecha válida
    const date = new Date(dateStr);
    return isNaN(date.getTime()) ? new Date(1970, 0, 1) : date;
  }
  
  function formatDate(ymd){ const d=parseLocalDate(ymd); return d.toLocaleDateString('es-CO',{day:'2-digit',month:'2-digit',year:'2-digit'}); }

  // Mapeo de enlaces de Coda por nombre de documento
  const documentLinks = {
    "Gestión de transferencias ACH": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/OP-PR-022-Gestion-de-transferencias-ACH_suemVnbM?search=Gesti%C3%B3n%20de%20transferencias%20ACH#Copy-of-Copy-of-Cabezote-122-44_tutlTec9",
    "Instructivo Actualización Fuente de Adquirencia": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/OP-IN-030-05-Instructivo-Actualizacion-Fuente-de-Adquirencia_sue8-tzy?docIds%5B0%5D=PZrHIIUQg-&search=Instructivo%20Actualizaci%C3%B3n%20Fuente%20de%20Adquirencia",
    "Instructivo Pago y liquidación de Bold CF a Bold CO SAS": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/OP-IN-030-06-Instructivo-Pago-y-liquidacion-de-Bold-CF-a-Bold-CO_suhVYdYL?docIds%5B0%5D=PZrHIIUQg-&search=Instructivo%20Pago%20y%20liquidaci%C3%B3n%20de%20Bold%20CF%20a%20Bold%20CO%20SAS",
    "Ajustes de adquirencia": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/OP-PR-033-Ajustes-de-adquirencia_sumfIGaP?docIds%5B0%5D=PZrHIIUQg-&search=Ajustes%20de%20adquirencia",
    "Comunicaciones a clientes": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/GM-PR-001-Comunicaciones-a-clientes_su45TOKR?docIds%5B0%5D=PZrHIIUQg-&search=Comunicaciones%20a%20clientes",
    "Reclutamiento de personal": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/TH-PR-001-Reclutamiento-de-personal_sudeRr7W?docIds%5B0%5D=PZrHIIUQg-&search=Reclutamiento%20de%20personal",
    "Offboarding de personal": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/TH-PR-008-Offboarding-de-personal_suz77-BW?docIds%5B0%5D=PZrHIIUQg-&search=Offboarding%20de%20personal",
    "Gestión programa ESOP": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/TH-PR-011-Gestion-programa-ESOP_suF9E_l6?docIds%5B0%5D=PZrHIIUQg-&search=Gesti%C3%B3n%20programa%20ESOP",
    "Liquidación y pago de aportes": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/TH-PR-012-Liquidacion-y-pago-de-aportes_su2dN3VF?docIds%5B0%5D=PZrHIIUQg-&search=Liquidaci%C3%B3n%20y%20pago%20de%20aportes",
    "Cambio interno de rol": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/TH-PR-024-Cambio-interno-de-rol_suF6NXPO?docIds%5B0%5D=PZrHIIUQg-&search=Cambio%20interno%20de%20rol",
    "Instructivo Generación Informe IRL": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/GF-IN-005-02-Instructivo-Generacion-Informe-IRL_suS5GFdM?docIds%5B0%5D=PZrHIIUQg-&search=Instructivo%20Generaci%C3%B3n%20Informe%20IRL",
    "Instructivo Generación Informe CFEN": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/GF-IN-005-03-Instructivo-Generacion-Informe-CFEN_suXq5J0X?docIds%5B0%5D=PZrHIIUQg-&search=Instructivo%20Generaci%C3%B3n%20Informe%20CFEN",
    "Instructivo conciliación cobro y recaudo tarjeta de crédito": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/GF-IN-030-01-Instructivo-conciliacion-cobro-y-recaudo-tarjeta-de_su_lHZig?docIds%5B0%5D=PZrHIIUQg-&search=Instructivo%20conciliaci%C3%B3n%20cobro%20y%20recaudo%20tarjeta%20de%20cr%C3%A9dito",
    "Instructivo control y seguimiento de cupos": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/GF-IN-030-02-Instructivo-control-y-seguimiento-de-cupos_su6SvZ8v?docIds%5B0%5D=PZrHIIUQg-&search=Instructivo%20control%20y%20seguimiento%20de%20cupos",
    "Gestión de Compras": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/SI-PR-004-Gestion-de-compras_suHNoYhL?docIds%5B0%5D=PZrHIIUQg-&search=Gesti%C3%B3n%20de%20Compras",
    "Selección y creación de terceros": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/SI-PR-006-Seleccion-y-creacion-de-terceros_supPV5mn?docIds%5B0%5D=PZrHIIUQg-&search=Selecci%C3%B3n%20y%20creaci%C3%B3n%20de%20terceros",
    "Recolección de activos fijos e implementos de trabajo en offboarding": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/SI-PR-008-Recoleccion-de-activos-fijos-e-implementos-de-trabajo-_suLlHh3z?docIds%5B0%5D=PZrHIIUQg-&search=Recolecci%C3%B3n%20de%20activos%20fijos%20e%20implementos%20de%20trabajo%20en%20offboarding",
    "Manual Ejecución Debida Diligencia Intensificada (DDI) CF": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/LC-MA-006-Manual-Ejecucion-Debida-Diligencia-Intensificada-DDI-C_suPEwkd7?docIds%5B0%5D=PZrHIIUQg-&search=Manual%20Ejecuci%C3%B3n%20Debida%20Diligencia%20Intensificada%20%28DDI%29%20CF",
    "Manual Metodológico Matriz de Riesgos SARLAFT": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/LC-MA-007-Manual-Metodologico-Matriz-de-Riesgos-SARLAFT_suzr4F8x?docIds%5B0%5D=PZrHIIUQg-&search=Manual%20Metodol%C3%B3gico%20Matriz%20de%20Riesgos%20SARLAFT",
    "Manual Metodología Segmentación de Riesgo Clientes": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/LC-MA-009-Manual-Metodologia-Segmentacion-de-Riesgo-Clientes_suWtffT_?docIds%5B0%5D=PZrHIIUQg-&search=Manual%20Metodolog%C3%ADa%20Segmentaci%C3%B3n%20de%20Riesgo%20Clientes",
    "Política activos fijos y elementos de trabajo": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/SI-PO-002-Politica-activos-fijos-y-elementos-de-trabajo_suY6mGAt?docIds%5B0%5D=PZrHIIUQg-&search=Pol%C3%ADtica%20activos%20fijos%20y%20elementos%20de%20trabajo",
    "Solicitud QR Bold (Entre cuentas)": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/AP-PR-010-Solicitud-QR-Bold-Entre-cuentas_suzb2RZ0?docIds%5B0%5D=PZrHIIUQg-&search=Solicitud%20QR%20Bold%20%28Entre%20cuentas%29",
    "Gestión comercial canal SMB": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/AP-PR-018-Gestion-comercial-canal-SMB_suix9GKp?docIds%5B0%5D=PZrHIIUQg-&search=Gesti%C3%B3n%20comercial%20canal%20SMB#Copy-of-Copy-6-of-ControlCambios-176_tuvOQ1P5/r3&columnId=c-M2SErj7365",
    "Gestión de beneficios": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/TH-PR-007-Gestion-de-beneficios_suN5hBT6?docIds%5B0%5D=PZrHIIUQg-&search=Gesti%C3%B3n%20de%20beneficios",
    "Liquidación y legalización de compras tarjetas corporativas": "https://coda.io/d/Arquitectura-de-Procesos_dPZrHIIUQg-/GF-PR-043-Liquidacion-y-legalizacion-de-compras-tarjetas-corpora_su4fFe1t?docIds%5B0%5D=PZrHIIUQg-&search=Liquidaci%C3%B3n%20y%20legalizaci%C3%B3n%20de%20compras%20tarjetas%20corporativas",
    "Validación de cuentas - KYC SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/VP-PR-103-Validacion-manual-de-cuentas-KYC-SAS_suZFDP1S?docIds%5B0%5D=ywYtLrlDx7&search=Validaci%C3%B3n%20de%20cuentas%20-%20KYC%20SAS",
    "Gestión comercial canal SMB SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/VP-PR-118-Gestion-comercial-canal-SMB-SAS_suC7ImXn?docIds%5B0%5D=ywYtLrlDx7&search=Gesti%C3%B3n%20comercial%20canal%20SMB%20SAS",
    "Validación de identidad de cliente": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/AC-PR-101-Validacion-de-Identidad-del-Cliente-SAS_suqyIsK1?docIds%5B0%5D=ywYtLrlDx7&search=Validaci%C3%B3n%20de%20identidad%20de%20cliente",
    "Gestión de beneficios SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/TH-PR-107-Gestion-de-beneficios-SAS_suj00PHg?docIds%5B0%5D=ywYtLrlDx7&search=Gesti%C3%B3n%20de%20beneficios%20SAS",
    "Entrenamiento inicial para el área comercial SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/TH-PR-126-Entrenamiento-inicial-para-el-area-comercial-SAS_suycUc6V?docIds%5B0%5D=ywYtLrlDx7&search=Entrenamiento%20inicial%20para%20el%20%C3%A1rea%20comercial%20SAS",
    "Entrenamiento continuo para el área comercial SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/TH-PR-127-Entrenamiento-continuo-para-el-area-comercial-SAS_su_ZHAwi?docIds%5B0%5D=ywYtLrlDx7&search=Entrenamiento%20continuo%20para%20el%20%C3%A1rea%20comercial%20SAS",
    "Conciliación de Saldos de Cuentas Virtuales": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/GF-PR-137-Conciliacion-de-Saldos-de-Cuentas-Virtuales_suluMbDK?docIds%5B0%5D=ywYtLrlDx7&search=Conciliaci%C3%B3n%20de%20Saldos%20de%20Cuentas%20Virtuales",
    "Liquidación y legalización de compras tarjetas corporativas SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/GF-PR-143-Liquidacion-y-legalizacion-de-compras-tarjetas-corpora_sugUGmqj?docIds%5B0%5D=ywYtLrlDx7&search=Liquidaci%C3%B3n%20y%20legalizaci%C3%B3n%20de%20compras%20tarjetas%20corporativas%20SAS",
    "Control de fuentes SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/GF-PR-144-Control-de-fuentes-SAS_suUnVL4L?docIds%5B0%5D=ywYtLrlDx7&search=Control%20de%20fuentes%20SAS",
    "Cierre diario de turno para clientes master merchant SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/OP-PR-169-Cierre-diario-de-turno-para-clientes-master-merchant-S_suOTZYVu?docIds%5B0%5D=ywYtLrlDx7&search=Cierre%20diario%20de%20turno%20para%20clientes%20master%20merchant%20SAS",
    "Comunicaciones a clientes SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/GM-PR-101-Comunicaciones-a-clientes-SAS_suO2I39n?docIds%5B0%5D=ywYtLrlDx7&search=Comunicaciones%20a%20clientes%20SAS",
    "Cambio interno de rol SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/TH-PR-124-Cambio-interno-de-rol_suz20-ca?docIds%5B0%5D=ywYtLrlDx7&search=Cambio%20interno%20de%20rol%20SAS",
    "Recolección de activos fijos e implementos de trabajo en offboarding SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/SI-PR-108-Recoleccion-de-activos-fijos-e-implementos-de-trabajo-_suRvgjLv?docIds%5B0%5D=ywYtLrlDx7&search=Recolecci%C3%B3n%20de%20activos%20fijos%20e%20implementos%20de%20trabajo%20en%20offboarding%20SAS",
    "Manual Ejecución Debida Diligencia Intensificada (DDI) SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/LC-MA-106-Manual-Ejecucion-Debida-Diligencia-Intensificada-DDI-S_suqy4vIX?docIds%5B0%5D=ywYtLrlDx7&search=Manual%20Ejecuci%C3%B3n%20Debida%20Diligencia%20Intensificada%20%28DDI%29%20SAS",
    "Documento Metodológico Matriz de Riesgos SAGRILAFT SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/LC-MA-107-Metodologico-Matriz-de-Riesgos-SAGRILAFT-SAS_suZRhaG_?docIds%5B0%5D=ywYtLrlDx7&search=Documento%20Metodol%C3%B3gico%20Matriz%20de%20Riesgos%20SAGRILAFT%20SAS",
    "Documento Metodológico Matriz de Riesgos PTEE (C/ST) - Programa de Transparencia y Ética Empresarial SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/LC-MA-108-Documento-Metodologico-Matriz-de-Riesgos-PTEE-C-ST-Pro_su6fWroN?docIds%5B0%5D=ywYtLrlDx7&search=Documento%20Metodol%C3%B3gico%20Matriz%20de%20Riesgos%20PTEE%20%28C%2FST%29%20-%20Programa%20de%20Transparencia%20y%20%C3%89tica%20Empresarial%20SAS",
    "Manual Metodología Segmentación de Riesgo Clientes SAS": "https://coda.io/d/Arquitectura-de-Procesos-Bold-co-SAS_dywYtLrlDx7/LC-MA-109-Manual-Metodologia-Segmentacion-de-Riesgo-Clientes-SAS_suIAroNe?docIds%5B0%5D=ywYtLrlDx7&search=Manual%20Metodolog%C3%ADa%20Segmentaci%C3%B3n%20de%20Riesgo%20Clientes%20SAS"
  };
  
  // Variables globales - se cargarán desde Google Sheets
  let rows = [];
  let cambios = [];

  const cardsEl = document.getElementById('cards');
  let query = '', sortMode='fecha';
  const pctColor = (p)=> p>=100?'bg-emerald-500':p>=80?'bg-green-500':p>=50?'bg-amber-500':'bg-slate-300';
  const status = (p)=> p>=100?['¡Listo!','bg-emerald-600 text-white']:p>=80?['Casi','bg-green-600 text-white']:['En curso','bg-slate-200 text-slate-800'];
  
  // Función para obtener el color del aplicativo
  const getApplicativeColor = (aplicativo) => {
    const app = (aplicativo || '').toUpperCase();
    switch(app) {
      case 'APPIAN': return '#0A53A5';
      case 'DAPTA': return '#1B8959';
      case 'N8N': return '#FF2947';
      default: return '#6B7280'; // gris por defecto
    }
  };
  
  // ======== SISTEMA DE FILTRADO POR MES/AÑO ========
  let currentSelectedMonth;
  let currentSelectedYear;
  
  // Mapeo de imágenes por mes/año - se carga dinámicamente desde Google Sheets
  // NOTA: Este objeto se reemplazará con los datos del sheet Valor_agregado
  // Fallback temporal mientras se actualiza el backend
  let valueAddedImages = {
    '2025-08': {
      sas: "https://drive.google.com/file/d/1ZbS5WyojhMcdcZz5TINSL2yGTxwQbskb/view",
      cf: "https://drive.google.com/file/d/1fUxaxuNvT5EdzAai_NvUL773Qq_mjk2O/view"
    },
    '2025-09': {
      sas: "https://drive.google.com/file/d/1Wn9xYfCdwWz7sW20dN4sye2oKVqoqdDz/view",
      cf: "https://drive.google.com/file/d/1DXerSbjHu3wzriAz5TFZfutwGs83e3N2/view"
    }
  }; // Se carga desde Google Sheets (fallback temporal)
  
  // Nombres de meses en español
  const monthNames = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
  ];
  
  // Función para obtener mes anterior al actual
  function getPreviousMonth() {
    const now = new Date();
    let year = now.getFullYear();
    let month = now.getMonth(); // 0-based (enero = 0)
    
    // Si estamos en enero, ir a diciembre del año anterior
    if (month === 0) {
      month = 11; // diciembre (0-based)
      year = year - 1;
    } else {
      month = month - 1; // mes anterior
    }
    
    // Convertir a 1-based para consistencia
    const monthNumber = month + 1;
    
    return {
      month: monthNumber,
      year: year,
      name: monthNames[month], // usar índice 0-based para monthNames
      key: `${year}-${String(monthNumber).padStart(2, '0')}`,
      display: `${monthNames[month]} ${year}`
    };
  }
  
  
  // Función para obtener años disponibles DINÁMICAMENTE desde los datos
  function getAvailableYears() {
    const years = new Set();
    
    // Obtener años de automatizaciones - SOLO mesAsignado (no fecha)
    rows.forEach(r => {
      if (r.mesAsignado) {
        const date = parseLocalDate(r.mesAsignado);
        years.add(date.getFullYear());
      }
      // Si no tiene mesAsignado, usar fecha como fallback
      else if (r.fecha) {
        const date = parseLocalDate(r.fecha);
        years.add(date.getFullYear());
      }
    });
    
    // Obtener años de procesos (solo tienen fecha)
    cambios.forEach(c => {
      if (c.fecha) {
        const date = parseLocalDate(c.fecha);
        years.add(date.getFullYear());
      }
    });
    
    // Convertir a array y ordenar
    return Array.from(years).sort((a, b) => b - a);
  }
  
  // Función para obtener meses disponibles DINÁMICAMENTE para un año específico
  function getAvailableMonthsForYear(year) {
    const months = new Set();
    
    // Obtener meses de automatizaciones - SOLO mesAsignado (no fecha)
    rows.forEach(r => {
      if (r.mesAsignado) {
        const date = parseLocalDate(r.mesAsignado);
        if (date.getFullYear() === year) {
          months.add(date.getMonth() + 1); // 1-based
        }
      }
      // Si no tiene mesAsignado, usar fecha como fallback
      else if (r.fecha) {
        const date = parseLocalDate(r.fecha);
        if (date.getFullYear() === year) {
          months.add(date.getMonth() + 1);
        }
      }
    });
    
    // Obtener meses de procesos (solo tienen fecha)
    cambios.forEach(c => {
      if (c.fecha) {
        const date = parseLocalDate(c.fecha);
        if (date.getFullYear() === year) {
          months.add(date.getMonth() + 1);
        }
      }
    });
    
    // Convertir a array, ordenar y formatear
    return Array.from(months)
      .sort((a, b) => b - a) // Descendente (más reciente primero)
      .map(monthNum => ({
        number: monthNum,
        name: monthNames[monthNum - 1],
        short: monthNames[monthNum - 1].substring(0, 3)
      }));
  }
  
  // Función para encontrar el último mes con datos disponibles
  function getLastAvailableMonth() {
    const allDates = [...rows.map(r => r.fecha), ...cambios.map(c => c.fecha)]
      .filter(fecha => fecha && fecha.includes('-'))
      .map(fecha => {
        const parts = fecha.split('-');
        return { year: parseInt(parts[0]), month: parseInt(parts[1]), date: fecha };
      })
      .sort((a, b) => b.year - a.year || b.month - a.month);
    
    if (allDates.length > 0) {
      const latest = allDates[0];
      return {
        month: latest.month,
        year: latest.year,
        name: monthNames[latest.month - 1],
        key: `${latest.year}-${String(latest.month).padStart(2, '0')}`,
        display: `${monthNames[latest.month - 1]} ${latest.year}`
      };
    }
    
    // Fallback al mes anterior actual
    return getPreviousMonth();
  }
  
  // Función para inicializar el mes por defecto - mes anterior con datos o último disponible
  function initializeDefaultMonth() {
    console.log('=== INICIALIZACIÓN CON VERIFICACIÓN DE DATOS ===');
    
    // Verificar si hay datos disponibles
    if (rows.length === 0 && cambios.length === 0) {
      console.warn('No hay datos disponibles en las hojas');
      // Usar mes anterior como fallback
      const fallbackMonth = getPreviousMonth();
      currentSelectedMonth = fallbackMonth.month;
      currentSelectedYear = fallbackMonth.year;
      const selectedMonthElement = document.getElementById('selectedMonth');
      if (selectedMonthElement) {
        selectedMonthElement.textContent = fallbackMonth.display;
      }
      updateAllSections();
      return fallbackMonth;
    }
    
    // Obtener mes anterior
    const previousMonth = getPreviousMonth();
    console.log('Mes anterior:', previousMonth.display);
    
    // Verificar si el mes anterior tiene datos
    const previousMonthKey = `${previousMonth.year}-${String(previousMonth.month).padStart(2, '0')}`;
    
    const hasDataInPreviousMonth = 
      rows.some(r => {
        if (r.mesAsignado) {
          const date = parseLocalDate(r.mesAsignado);
          const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          return key === previousMonthKey;
        }
        if (r.fecha) {
          const date = parseLocalDate(r.fecha);
          const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          return key === previousMonthKey;
        }
        return false;
      }) ||
      cambios.some(c => {
        if (c.fecha) {
          const date = parseLocalDate(c.fecha);
          const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          return key === previousMonthKey;
        }
        return false;
      });
    
    let selectedMonth;
    
    if (hasDataInPreviousMonth) {
      console.log('✅ Mes anterior tiene datos, usándolo');
      selectedMonth = previousMonth;
    } else {
      console.log('⚠️ Mes anterior NO tiene datos, buscando último mes con datos...');
      selectedMonth = getLastAvailableMonth();
      console.log('✅ Último mes con datos:', selectedMonth.display);
    }
    
    // Establecer variables globales
    currentSelectedMonth = selectedMonth.month;
    currentSelectedYear = selectedMonth.year;
    
    console.log('Variables establecidas:', { currentSelectedMonth, currentSelectedYear });
    
    // Actualizar UI inmediatamente
    const selectedMonthElement = document.getElementById('selectedMonth');
    if (selectedMonthElement) {
      selectedMonthElement.textContent = selectedMonth.display;
      console.log('UI actualizada con:', selectedMonth.display);
    }
    
    console.log('Actualizando todas las secciones...');
    // Actualizar todas las secciones inmediatamente
    updateAllSections();
    
    // Verificación final de que el DOM está actualizado
    setTimeout(() => {
      console.log('=== VERIFICACIÓN FINAL ===');
      console.log('Contenedor automatizaciones:', document.getElementById('cards')?.children.length || 0, 'cards');
      console.log('Tabla cambios filas:', document.getElementById('tbodyCambios')?.children.length || 0, 'filas');
      console.log('Botón mes muestra:', document.getElementById('selectedMonth')?.textContent || 'N/A');
    }, 100);
    
    console.log('=== INICIALIZACIÓN COMPLETADA ===');
    return selectedMonth;
  }
  
  // Variables temporales para el selector (se inicializarán después)
  let tempSelectedYear;
  let tempSelectedMonth;
  
  // Funciones para dropdowns personalizados
  function populateMonthDropdown() {
    populateCustomYearDropdown();
    populateCustomMonthDropdown();
    
    // Event listeners para dropdowns personalizados
    document.getElementById('yearSelectBtn').addEventListener('click', toggleYearDropdown);
    document.getElementById('monthSelectBtn').addEventListener('click', toggleMonthDropdownInternal);
  }
  
  function populateCustomYearDropdown() {
    const yearOptions = document.getElementById('yearOptions');
    const yearSelectedText = document.getElementById('yearSelectedText');
    const availableYears = getAvailableYears();
    
    yearOptions.innerHTML = '';
    yearSelectedText.textContent = tempSelectedYear;
    
    availableYears.forEach(year => {
      const option = document.createElement('div');
      option.className = `px-4 py-3 cursor-pointer transition-colors hover:bg-blue-50 ${
        year === tempSelectedYear ? 'font-bold' : 'font-medium'
      }`;
      option.style.color = year === tempSelectedYear ? '#121E6C' : '#374151';
      option.textContent = year;
      
      option.addEventListener('click', () => selectYear(year));
      yearOptions.appendChild(option);
    });
  }
  
  function populateCustomMonthDropdown() {
    const monthOptions = document.getElementById('monthOptions');
    const monthSelectedText = document.getElementById('monthSelectedText');
    const availableMonths = getAvailableMonthsForYear(tempSelectedYear);
    
    monthOptions.innerHTML = '';
    
    // Encontrar nombre del mes seleccionado
    const selectedMonthObj = availableMonths.find(m => m.number === tempSelectedMonth);
    monthSelectedText.textContent = selectedMonthObj ? selectedMonthObj.name : 'Seleccionar...';
    
    availableMonths.forEach(month => {
      const option = document.createElement('div');
      option.className = `px-4 py-3 cursor-pointer transition-colors hover:bg-blue-50 ${
        month.number === tempSelectedMonth ? 'font-bold' : 'font-medium'
      }`;
      option.style.color = month.number === tempSelectedMonth ? '#121E6C' : '#374151';
      option.textContent = month.name;
      
      option.addEventListener('click', () => {
        // Usar directamente la función que sabemos que funciona
        selectMonthDirectly(tempSelectedYear, month.number);
      });
      monthOptions.appendChild(option);
    });
  }
  
  function toggleYearDropdown() {
    const dropdown = document.getElementById('yearDropdown');
    const icon = document.getElementById('yearDropIcon');
    const monthDropdown = document.getElementById('monthDropdownCustom');
    
    // Cerrar dropdown de mes si está abierto
    monthDropdown.classList.add('hidden');
    document.getElementById('monthDropIcon').style.transform = 'rotate(0deg)';
    
    if (dropdown.classList.contains('hidden')) {
      dropdown.classList.remove('hidden');
      icon.style.transform = 'rotate(180deg)';
    } else {
      dropdown.classList.add('hidden');
      icon.style.transform = 'rotate(0deg)';
    }
  }
  
  function toggleMonthDropdownInternal() {
    const dropdown = document.getElementById('monthDropdownCustom');
    const icon = document.getElementById('monthDropIcon');
    const yearDropdown = document.getElementById('yearDropdown');
    
    // Cerrar dropdown de año si está abierto
    yearDropdown.classList.add('hidden');
    document.getElementById('yearDropIcon').style.transform = 'rotate(0deg)';
    
    if (dropdown.classList.contains('hidden')) {
      dropdown.classList.remove('hidden');
      icon.style.transform = 'rotate(180deg)';
    } else {
      dropdown.classList.add('hidden');
      icon.style.transform = 'rotate(0deg)';
    }
  }
  
  function selectYear(year) {
    tempSelectedYear = year;
    
    // Verificar si el mes actual está disponible en el nuevo año
    const availableMonths = getAvailableMonthsForYear(year);
    const monthNumbers = availableMonths.map(m => m.number);
    if (!monthNumbers.includes(tempSelectedMonth)) {
      tempSelectedMonth = monthNumbers[monthNumbers.length - 1]; // Seleccionar el último mes disponible
    }
    
    // Cambiar directamente sin esperar confirmación
    selectMonthDirectly(tempSelectedYear, tempSelectedMonth);
  }
  
  function selectMonth_internal(monthNumber) {
    tempSelectedMonth = monthNumber;
    
    // Actualizar dropdown de mes
    populateCustomMonthDropdown();
    
    // Cerrar dropdown
    document.getElementById('monthDropdownCustom').classList.add('hidden');
    document.getElementById('monthDropIcon').style.transform = 'rotate(0deg)';
  }
  
  // Función directa para cambiar el mes inmediatamente (sin confirmación)
  function selectMonthDirectly(year, month) {
    currentSelectedMonth = month;
    currentSelectedYear = year;
    
    // Actualizar UI inmediatamente
    const monthName = monthNames[month - 1];
    const display = `${monthName} ${year}`;
    document.getElementById('selectedMonth').textContent = display;
    
    // Actualizar todas las secciones
    updateAllSections();
    
    // Cerrar dropdown si está abierto
    hideMonthDropdown();
  }
  
  // Esta función ya no se usa directamente, pero la mantenemos por compatibilidad
  function selectMonth(monthData) {
    currentSelectedMonth = monthData.month;
    currentSelectedYear = monthData.year;
    
    // Actualizar UI
    document.getElementById('selectedMonth').textContent = monthData.display;
    
    // Cerrar dropdown
    hideMonthDropdown();
    
    // Actualizar todas las secciones
    updateAllSections();
  }
  
  // Función principal para toggle del selector principal
  function toggleMonthDropdown() {
    const dropdown = document.getElementById('monthDropdown');
    const icon = document.getElementById('monthDropdownIcon');
    
    if (dropdown.classList.contains('hidden')) {
      showMonthDropdown();
    } else {
      hideMonthDropdown();
    }
  }
  
  function showMonthDropdown() {
    const dropdown = document.getElementById('monthDropdown');
    const icon = document.getElementById('monthDropdownIcon');
    
    // Inicializar variables temporales con valores actuales (sin fallback que cause desincronización)
    tempSelectedYear = currentSelectedYear;
    tempSelectedMonth = currentSelectedMonth;
    
    // Limpiar event listeners previos
    const yearSelectBtn = document.getElementById('yearSelectBtn');
    const monthSelectBtn = document.getElementById('monthSelectBtn');
    if (yearSelectBtn) yearSelectBtn.removeEventListener('click', toggleYearDropdown);
    if (monthSelectBtn) monthSelectBtn.removeEventListener('click', toggleMonthDropdownInternal);
    
    populateMonthDropdown();
    dropdown.classList.remove('hidden');
    icon.style.transform = 'rotate(180deg)';
    
    // Cerrar al hacer clic fuera
    setTimeout(() => {
      document.addEventListener('click', handleClickOutside);
    }, 100);
  }
  
  function confirmSelection() {
    // Aplicar selección temporal
    currentSelectedMonth = tempSelectedMonth;
    currentSelectedYear = tempSelectedYear;
    
    // Actualizar UI
    const monthName = monthNames[currentSelectedMonth - 1];
    const display = `${monthName} ${currentSelectedYear}`;
    document.getElementById('selectedMonth').textContent = display;
    
    // Cerrar dropdown
    hideMonthDropdown();
    
    // Actualizar todas las secciones
    updateAllSections();
  }
  
  function hideMonthDropdown() {
    const dropdown = document.getElementById('monthDropdown');
    const icon = document.getElementById('monthDropdownIcon');
    
    // Cerrar dropdowns personalizados también
    const yearDropdown = document.getElementById('yearDropdown');
    const monthDropdownCustom = document.getElementById('monthDropdownCustom');
    if (yearDropdown) yearDropdown.classList.add('hidden');
    if (monthDropdownCustom) monthDropdownCustom.classList.add('hidden');
    
    // Resetear iconos
    const yearDropIcon = document.getElementById('yearDropIcon');
    const monthDropIcon = document.getElementById('monthDropIcon');
    if (yearDropIcon) yearDropIcon.style.transform = 'rotate(0deg)';
    if (monthDropIcon) monthDropIcon.style.transform = 'rotate(0deg)';
    
    dropdown.classList.add('hidden');
    icon.style.transform = 'rotate(0deg)';
    document.removeEventListener('click', handleClickOutside);
    
    // Limpiar event listeners
    const yearSelectBtn = document.getElementById('yearSelectBtn');
    const monthSelectBtn = document.getElementById('monthSelectBtn');
    if (yearSelectBtn) yearSelectBtn.removeEventListener('click', toggleYearDropdown);
    if (monthSelectBtn) monthSelectBtn.removeEventListener('click', toggleMonthDropdownInternal);
  }
  
  function handleClickOutside(event) {
    const selector = document.getElementById('monthSelector');
    const dropdown = document.getElementById('monthDropdown');
    const yearDropdown = document.getElementById('yearDropdown');
    const monthDropdownCustom = document.getElementById('monthDropdownCustom');
    
    // Si se hizo clic fuera de todos los elementos, cerrar
    if (!selector.contains(event.target) && 
        !dropdown.contains(event.target) &&
        !yearDropdown.contains(event.target) &&
        !monthDropdownCustom.contains(event.target)) {
      hideMonthDropdown();
    }
  }
  
  // Función para actualizar imágenes de valor agregado
  function updateValueAddedImages() {
    const monthKey = `${currentSelectedYear}-${String(currentSelectedMonth).padStart(2, '0')}`;
    console.log('🖼️ updateValueAddedImages() - monthKey:', monthKey);
    console.log('🖼️ valueAddedImages disponibles:', Object.keys(valueAddedImages));
    console.log('🖼️ valueAddedImages completo:', valueAddedImages);
    
    const images = valueAddedImages[monthKey]; // sin fallback - solo si hay datos específicos
    console.log('🖼️ Imágenes para', monthKey, ':', images);
    
    const cardsContainer = document.getElementById('valueAddedCards');
    const noResultsContainer = document.getElementById('noResultsValueAdded');
    const noResultsText = document.getElementById('noResultsTextValueAdded');
    
    // Si no hay imágenes para este mes, mostrar mensaje de "No hay datos"
    if (!images) {
      console.log('❌ No hay imágenes para este mes');
      cardsContainer.classList.add('hidden');
      noResultsContainer.classList.remove('hidden');
      noResultsText.textContent = `No hay imágenes de valor agregado disponibles para ${monthNames[currentSelectedMonth - 1]} ${currentSelectedYear}.`;
      return;
    }
    
    console.log('✅ Mostrando imágenes:', images);
    
    // Si hay imágenes, mostrar las tarjetas y ocultar el mensaje
    cardsContainer.classList.remove('hidden');
    noResultsContainer.classList.add('hidden');
    
    const img1 = document.getElementById('img1');
    const img2 = document.getElementById('img2');
    
    // Cargar las imágenes específicas
    if (img1 && images.sas) {
      setDriveImage(img1, images.sas);
    }
    
    if (img2 && images.cf) {
      setDriveImage(img2, images.cf);
    }
  }
  
  // Función para actualizar todas las secciones
  function updateAllSections() {
    console.log('updateAllSections() con:', { currentSelectedMonth, currentSelectedYear });
    updateValueAddedImages();
    renderAutoFiltered();
    renderCambios();
    console.log('Todas las secciones actualizadas');
  }
  
  // Función mejorada de renderAuto con filtro de fecha
  function renderAutoFiltered() {
    console.log('renderAutoFiltered() INICIO - Variables:', { currentSelectedMonth, currentSelectedYear });
    
    // Si no hay variables válidas, salir
    if (!currentSelectedMonth || !currentSelectedYear) {
      console.error('❌ renderAutoFiltered() - Variables inválidas:', { currentSelectedMonth, currentSelectedYear });
      return;
    }
    
    const monthKey = `${currentSelectedYear}-${String(currentSelectedMonth).padStart(2, '0')}`;
    console.log('renderAutoFiltered() - MonthKey calculado:', monthKey);
    console.log('renderAutoFiltered() - Total automatizaciones disponibles:', rows.length);
    
    const list = rows.filter(r => {
      // Filtrar por mes asignado O por fecha del mes seleccionado
      let belongsToMonth = false;
      
      // Opción 1: Verificar si tiene mesAsignado que coincida
      if (r.mesAsignado) {
        // Si mesAsignado es una fecha (viene de Google Sheets), extraer año-mes
        let mesAsignadoKey = r.mesAsignado;
        if (r.mesAsignado.includes('T') || r.mesAsignado.length > 10) {
          // Es una fecha completa, extraer solo año-mes
          const date = parseLocalDate(r.mesAsignado);
          mesAsignadoKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }
        
        if (mesAsignadoKey === monthKey) {
          belongsToMonth = true;
        }
      }
      // Opción 2: Verificar por fecha si no tiene mesAsignado
      else if (!r.mesAsignado && r.fecha) {
        const itemDate = parseLocalDate(r.fecha);
        const itemMonthKey = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}`;
        
        if (itemMonthKey === monthKey) {
          belongsToMonth = true;
        }
      }
      
      // Log para los primeros elementos para debugging
      if (rows.indexOf(r) < 3) {
        console.log(`Comparando automatización: ${r.aplicacion} - mesAsignado: ${r.mesAsignado || 'N/A'} - fecha: ${r.fecha} vs ${monthKey} - pertenece: ${belongsToMonth}`);
      }
      
      if (!belongsToMonth) return false;
      
      // Filtrar por búsqueda
      return (r.aplicativo + ' ' + r.aplicacion + ' ' + r.proceso + ' ' + r.detalle + ' ' + r.compania).toLowerCase().includes(query.toLowerCase());
    })
    .sort((a,b) => sortMode === 'fecha' ? (parseLocalDate(b.fecha) - parseLocalDate(a.fecha)) : (Number(b.vaFinal) - Number(a.vaFinal)));
    
    console.log('renderAutoFiltered() - Automatizaciones filtradas:', list.length);
    if (list.length > 0) {
      console.log('Primeras automatizaciones encontradas:', list.slice(0, 2).map(r => ({ aplicacion: r.aplicacion, fecha: r.fecha })));
    }
    
    // Verificar que el contenedor existe
    if (!cardsEl) {
      console.error('❌ cardsEl no encontrado!');
      return;
    }
    
    const noResultsDiv = document.getElementById('noResultsAuto');
    const noResultsText = document.getElementById('noResultsTextAuto');
    
    console.log('Limpiando contenedor cardsEl...');
    cardsEl.innerHTML = '';
    
    if (list.length === 0) {
      noResultsDiv.classList.remove('hidden');
      
      if (query.trim()) {
        noResultsText.textContent = `No hay resultados para "${query.trim()}" en ${monthNames[currentSelectedMonth - 1]} ${currentSelectedYear}`;
      } else {
        noResultsText.textContent = `No se encontraron automatizaciones para ${monthNames[currentSelectedMonth - 1]} ${currentSelectedYear}.`;
      }
      
      return;
    } else {
      noResultsDiv.classList.add('hidden');
    }
    
    // Resto del código de renderizado igual que antes...
    list.forEach(r => {
      const card = document.createElement('div');
      card.className = 'fade-in rounded-3xl card-shadow bg-white transition-all duration-300 min-h-[420px] flex flex-col';
      
      let procesosHtml = '';
      if (r.proceso) {
        const procesos = r.proceso.split('\n').filter(p => p.trim());
        if (procesos.length > 1) {
          procesosHtml = '<div class="text-sm font-medium text-slate-700 mb-2">Procesos involucrados:</div><ul class="text-sm text-slate-600 space-y-1 ml-2">';
          procesos.forEach(proceso => {
            procesosHtml += `<li class="flex items-start"><span class="text-indigo-500 mr-2 mt-0.5">•</span><span>${proceso.trim()}</span></li>`;
          });
          procesosHtml += '</ul>';
        } else {
          procesosHtml = `<div class="text-sm font-medium text-slate-700 mb-1">Procesos involucrados:</div><div class="text-sm text-slate-600">${procesos[0]}</div>`;
        }
      }
      
      const detalleText = (r.detalle && !isNaN(r.detalle) === false) ? r.detalle : (r.detalle || 'Sin detalles específicos');
      const cardId = `card-${Math.random().toString(36).substr(2, 9)}`; // ID único para cada card
      const isLongDescription = detalleText.length > 150; // Considerar largo si tiene más de 150 caracteres
      
      const applicativeColor = getApplicativeColor(r.aplicativo);
      
      card.innerHTML = `
        <div class="h-full flex flex-col">
          <div class="bg-gradient-to-br from-slate-50 to-gray-100 p-6 rounded-t-3xl h-32 flex flex-col justify-between">
            <h3 class="font-bold text-lg text-gray-900 leading-tight line-clamp-2 flex-1">${r.aplicacion || ''}</h3>
            <div class="flex items-center gap-2 mt-2">
              <span class="text-xs px-2 py-1 rounded-md font-bold text-white" style="background-color: ${applicativeColor}; border: 1px solid ${applicativeColor};">${r.aplicativo || ''}</span>
              <span class="text-xs px-2 py-1 bg-gray-900 text-white rounded-md">${r.compania || ''}</span>
            </div>
          </div>
          <div class="flex-1 p-6 flex flex-col justify-between">
            <div class="space-y-4 mb-4">
              <div>${procesosHtml}</div>
              <div class="bg-gray-50 p-4 rounded-xl">
                <div class="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">Descripción</div>
                <div class="description-container">
                  <p id="desc-${cardId}" class="text-sm text-gray-700 ${isLongDescription ? 'line-clamp-3' : ''}">${detalleText}</p>
                  ${isLongDescription ? `
                    <button onclick="toggleDescription('${cardId}')" class="mt-2 text-xs text-blue-600 hover:text-blue-800 font-medium focus:outline-none" style="color: #121E6C;">
                      <span id="btn-${cardId}">Ver más</span>
                    </button>
                  ` : ''}
                </div>
              </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl mt-auto">
              <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div class="text-xs text-gray-500 font-medium mb-1">VA Inicial</div>
                  <div class="font-bold text-lg text-gray-700">${Math.round(Number(r.vaInicial || 0))}%</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500 font-medium mb-1">Incremento</div>
                  <div class="font-bold text-lg" style="color: #6CDCAB">+${Math.round(Number(r.incrementoVA || 0))}%</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500 font-medium mb-1">VA Final</div>
                  <div class="font-bold text-xl bold-primary">${Math.round(Number(r.vaFinal || 0))}%</div>
                </div>
              </div>
            </div>
          </div>
          <div class="px-6 pb-6">
            <div class="text-xs text-gray-500 flex items-center justify-center gap-2 py-3 bg-gray-50 rounded-xl">
              <img src="calendar-icon.png" alt="Calendario" class="w-4 h-4 opacity-60"> Fecha en prod: <span class="font-semibold text-gray-700">${formatDate(r.fecha)}</span>
            </div>
          </div>
        </div>
      `;
      
      cardsEl.appendChild(card);
    });
    
    console.log(`✅ ${list.length} automatizaciones agregadas al contenedor`);
  }
  
  // Función para toggle de descripciones largas
  window.toggleDescription = function(cardId) {
    const descElement = document.getElementById(`desc-${cardId}`);
    const btnElement = document.getElementById(`btn-${cardId}`);
    
    if (descElement.classList.contains('line-clamp-3')) {
      // Expandir
      descElement.classList.remove('line-clamp-3');
      btnElement.textContent = 'Ver menos';
    } else {
      // Colapsar
      descElement.classList.add('line-clamp-3');
      btnElement.textContent = 'Ver más';
    }
  };
  
  // Reemplazar la función renderAuto original
  function renderAuto() {
    renderAutoFiltered();
  }
  document.getElementById('q').addEventListener('input',(e)=>{query=e.target.value;renderAuto();});
  document.getElementById('resetBtn').addEventListener('click',()=>{
    query='';
    sortMode='fecha';
    document.getElementById('q').value='';
    renderAuto();
  });

  // ======== CAMBIOS — listado con paginación ========
  const tbodyCambios=document.getElementById('tbodyCambios');
  const countCambios=document.getElementById('countCambios');
  const pageInfo=document.getElementById('pageInfo');
  const prevBtn=document.getElementById('prevPage');
  const nextBtn=document.getElementById('nextPage');
  let q2 = '', sort2 = 'va', page = 1, pageSize = 10; // Ordenar por VA descendente por defecto
  let columnFilters = {}; // Objeto para guardar filtros por columna
  let currentFilterColumn = '';
  
  // Función para mostrar dropdown de filtro
  window.showFilterDropdown = function(column, event) {
    event.stopPropagation();
    currentFilterColumn = column;
    
    const dropdown = document.getElementById('filterDropdown');
    const rect = event.target.getBoundingClientRect();
    
    // Posicionar dropdown
    dropdown.style.left = Math.min(rect.left, window.innerWidth - 280) + 'px';
    dropdown.style.top = (rect.bottom + 5) + 'px';
    
    // Poblar opciones de filtro para la columna
    populateFilterOptions(column);
    
    dropdown.classList.remove('hidden');
    
    // Cerrar dropdown al hacer click fuera
    setTimeout(() => {
      document.addEventListener('click', hideFilterDropdownOutside);
    }, 100);
  }
  
  // Función para ocultar dropdown
  window.hideFilterDropdown = function() {
    const dropdown = document.getElementById('filterDropdown');
    dropdown.classList.add('hidden');
    document.removeEventListener('click', hideFilterDropdownOutside);
  }
  
  function hideFilterDropdownOutside(event) {
    const dropdown = document.getElementById('filterDropdown');
    if (!dropdown.contains(event.target)) {
      hideFilterDropdown();
    }
  }
  
  // Función para poblar las opciones de filtro de una columna
  function populateFilterOptions(column) {
    const filterOptions = document.getElementById('filterOptions');
    const columnSearch = document.getElementById('columnSearch');
    
    // Obtener valores únicos de la columna
    let values = [];
    cambios.forEach(row => {
      let value = '';
      switch(column) {
        case 'codigo': value = row.codigo || ''; break;
        case 'documento': value = row.documento || ''; break;
        case 'dueno': value = row.dueno || ''; break;
        case 'detalle': value = row.detalle || ''; break;
        case 'compania': value = row.compania || ''; break;
        case 'tipo': value = row.tipo || ''; break;
        case 'fecha': value = formatDate(row.fecha) || ''; break;
        case 'va': value = row.valor_agregado || 'N/A'; break;
      }
      if (value && !values.includes(value)) {
        values.push(value);
      }
    });
    
    values.sort();
    
    // Limpiar opciones anteriores
    filterOptions.innerHTML = '';
    columnSearch.value = '';
    
    // Crear checkboxes para cada valor
    const currentFilters = columnFilters[column] || [];
    const allSelected = currentFilters.length === 0;
    
    values.forEach(value => {
      const isSelected = allSelected || currentFilters.includes(value);
      
      const label = document.createElement('label');
      label.className = 'flex items-center gap-2 px-2 py-1 hover:bg-gray-50 text-sm filter-option';
      label.innerHTML = `
        <input type="checkbox" value="${value}" ${isSelected ? 'checked' : ''} onchange="updateSelectAll()">
        <span>${value}</span>
      `;
      filterOptions.appendChild(label);
    });
    
    // Actualizar estado del "Seleccionar todo"
    document.getElementById('selectAll').checked = allSelected;
    
    // Event listener para búsqueda dentro de la columna
    columnSearch.oninput = function() {
      const searchTerm = this.value.toLowerCase();
      const options = filterOptions.querySelectorAll('.filter-option');
      options.forEach(option => {
        const text = option.textContent.toLowerCase();
        option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
      });
    };
  }
  
  // Función para toggle de "Seleccionar todo"
  window.toggleAllFilters = function() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('#filterOptions input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
      if (checkbox.closest('.filter-option').style.display !== 'none') {
        checkbox.checked = selectAll.checked;
      }
    });
  }
  
  // Función para actualizar estado del "Seleccionar todo"
  window.updateSelectAll = function() {
    const checkboxes = Array.from(document.querySelectorAll('#filterOptions input[type="checkbox"]'));
    const visibleCheckboxes = checkboxes.filter(cb => cb.closest('.filter-option').style.display !== 'none');
    const checkedBoxes = visibleCheckboxes.filter(cb => cb.checked);
    
    const selectAll = document.getElementById('selectAll');
    selectAll.checked = checkedBoxes.length === visibleCheckboxes.length;
    selectAll.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < visibleCheckboxes.length;
  }
  
  // Función para aplicar ordenamiento desde el dropdown
  window.applySortFilter = function(direction) {
    sort2 = currentFilterColumn + (direction === 'asc' ? '-asc' : '');
    page = 1;
    renderCambios();
    hideFilterDropdown();
  }
  
  // Función para aplicar filtros de columna
  window.applyColumnFilter = function() {
    const checkboxes = document.querySelectorAll('#filterOptions input[type="checkbox"]:checked');
    const selectedValues = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedValues.length === document.querySelectorAll('#filterOptions input[type="checkbox"]').length) {
      // Si todos están seleccionados, no aplicar filtro
      delete columnFilters[currentFilterColumn];
    } else {
      // Aplicar filtro con valores seleccionados
      columnFilters[currentFilterColumn] = selectedValues;
    }
    
    page = 1;
    renderCambios();
    hideFilterDropdown();
  }
  
  // Función para limpiar filtro de la columna actual
  window.clearColumnFilter = function() {
    delete columnFilters[currentFilterColumn];
    page = 1;
    renderCambios();
    hideFilterDropdown();
  }
  
  // Función para obtener el color de VA según el valor
  function getVAColor(valorAgregado) {
    if (!valorAgregado || String(valorAgregado).trim() === '' || String(valorAgregado).toUpperCase() === 'N/A') {
      return '#606060'; // Gris para "No aplica"
    }
    
    const numValue = parseFloat(String(valorAgregado).replace('%', '')) || 0;
    
    if (numValue >= 60) {
      return '#6CDCAB'; // Verde para 60% o más
    } else if (numValue >= 31) {
      return '#FFC217'; // Amarillo para 31-59%
    } else {
      return '#C31A2F'; // Rojo para 0-30%
    }
  }

 function rowCambios(r){
    // Nuevo estilo para las etiquetas: sin negrita, fondo gris claro, centradas
    const tipoStyle = 'background-color: #f1f2f6; color: #6b7280;';
    
    // Formatear VA redondeado sin decimales
    let va;
    if (!r.valor_agregado || String(r.valor_agregado).trim() === '' || String(r.valor_agregado).toUpperCase() === 'N/A') {
      va = 'No aplica';
    } else {
      const numValue = parseFloat(String(r.valor_agregado).replace('%', ''));
      va = isNaN(numValue) ? r.valor_agregado : `${Math.round(numValue)}%`;
    }
    
    // Obtener color para VA
    const vaColor = getVAColor(r.valor_agregado);
    
    // Verificar si existe un enlace para el documento (priorizar url_proceso de Sheets)
    const documentoNombre = r.documento || '';
    const documentoLink = r.url_proceso || documentLinks[documentoNombre]; // Priorizar URL de Sheets
    const documentoHTML = documentoLink 
      ? `<a href="${documentoLink}" target="_blank" rel="noopener noreferrer" class="text-bold-primary underline hover:no-underline font-medium">${documentoNombre}</a>`
      : documentoNombre;
    
    // Procesar detalle: truncar si es muy largo y agregar tooltip
    const detalleTexto = r.detalle || '';
    const MAX_LENGTH = 150;
    const detalleTruncado = detalleTexto.length > MAX_LENGTH 
      ? detalleTexto.substring(0, MAX_LENGTH) + '...' 
      : detalleTexto;
    const detalleHTML = detalleTexto.length > MAX_LENGTH
      ? `<div class="relative detalle-cell" style="max-width: 400px;">
           <span class="detalle-preview cursor-pointer">${detalleTruncado}</span>
           <div class="detalle-tooltip hidden fixed z-[9999] bg-white rounded-xl p-4 text-sm" style="min-width: 300px; max-width: 500px; color: #334155; line-height: 1.6; box-shadow: 0 10px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);">
             ${detalleTexto}
           </div>
         </div>`
      : `<span>${detalleTexto}</span>`;

    return `
      <tr class="border-b border-slate-100 hover:bg-slate-50">
        <td class="px-3 py-2 font-medium text-slate-800 w-32">${r.codigo}</td>
        <td class="px-3 py-2">${documentoHTML}</td>
        <td class="px-3 py-2 w-48 text-sm" title="${r.dueno || ''}">${r.dueno || ''}</td>
        <td class="px-3 py-2 text-slate-700 relative">${detalleHTML}</td>
        <td class="px-3 py-2 w-20 text-center">${r.compania || ''}</td>
        <td class="px-3 py-2 w-32 text-center">
          <span class="inline-flex items-center justify-center text-xs px-3 py-2 rounded-full min-w-[90px] h-6" style="${tipoStyle}">${r.tipo}</span>
        </td>
        <td class="px-3 py-2 w-28 text-center">${formatDate(r.fecha)}</td>
        <td class="px-3 py-2 w-20 text-center">
          <span class="font-bold" style="color: ${vaColor};">${va}</span>
        </td>
      </tr>
    `;
  }
  function getFilteredCambios(){ 
    console.log('getFilteredCambios() INICIO - Variables:', { currentSelectedMonth, currentSelectedYear });
    console.log('Total cambios disponibles:', cambios.length);
    
    const filtered = cambios
      .filter(r => {
        // Filtro por fecha del mes seleccionado - aplicar si las variables son válidas
        if (currentSelectedMonth && currentSelectedYear && r.fecha) {
          const itemDate = parseLocalDate(r.fecha);
          const itemMonth = itemDate.getMonth() + 1; // 1-based
          const itemYear = itemDate.getFullYear();
          
          // Log de comparación para los primeros elementos
          if (cambios.indexOf(r) < 3) {
            console.log(`Comparando cambio: ${r.codigo} - ${r.fecha} (${itemMonth}/${itemYear}) vs (${currentSelectedMonth}/${currentSelectedYear})`);
          }
          
          if (itemMonth !== currentSelectedMonth || itemYear !== currentSelectedYear) {
            return false;
          }
        }
        
        // Filtro de búsqueda global
        if (q2) {
          const searchStr = (r.codigo + ' ' + r.documento + ' ' + (r.dueno || '') + ' ' + (r.detalle || '') + ' ' + (r.compania || '') + ' ' + (r.valor_agregado || '')).toLowerCase();
          if (!searchStr.includes(q2.toLowerCase())) return false;
        }
        
        // Filtros por columna
        for (const [column, filters] of Object.entries(columnFilters)) {
          if (filters && filters.length > 0) {
            let value = '';
            switch(column) {
              case 'codigo': value = r.codigo || ''; break;
              case 'documento': value = r.documento || ''; break;
              case 'dueno': value = r.dueno || ''; break;
              case 'detalle': value = r.detalle || ''; break;
              case 'compania': value = r.compania || ''; break;
              case 'tipo': value = r.tipo || ''; break;
              case 'fecha': value = formatDate(r.fecha) || ''; break;
              case 'va': value = r.valor_agregado || 'N/A'; break;
            }
            if (!filters.includes(value)) return false;
          }
        }
        
        return true;
      })
      .sort((a, b) => {
        if (sort2 === 'fecha') return parseLocalDate(b.fecha) - parseLocalDate(a.fecha);
        if (sort2 === 'fecha-asc') return parseLocalDate(a.fecha) - parseLocalDate(b.fecha);
        if (sort2 === 'codigo') return (b.codigo || '').localeCompare(a.codigo || '');
        if (sort2 === 'codigo-asc') return (a.codigo || '').localeCompare(b.codigo || '');
        if (sort2 === 'documento') return (b.documento || '').localeCompare(a.documento || '');
        if (sort2 === 'documento-asc') return (a.documento || '').localeCompare(b.documento || '');
        if (sort2 === 'dueno') return (b.dueno || '').localeCompare(a.dueno || '');
        if (sort2 === 'dueno-asc') return (a.dueno || '').localeCompare(b.dueno || '');
        if (sort2 === 'compania') return (b.compania || '').localeCompare(a.compania || '');
        if (sort2 === 'compania-asc') return (a.compania || '').localeCompare(b.compania || '');
        if (sort2 === 'tipo') return (b.tipo || '').localeCompare(a.tipo || '');
        if (sort2 === 'tipo-asc') return (a.tipo || '').localeCompare(b.tipo || '');
        if (sort2 === 'va') {
          const aVal = parseFloat(String(a.valor_agregado).replace('%', '')) || 0;
          const bVal = parseFloat(String(b.valor_agregado).replace('%', '')) || 0;
          return bVal - aVal;
        }
        if (sort2 === 'va-asc') {
          const aVal = parseFloat(String(a.valor_agregado).replace('%', '')) || 0;
          const bVal = parseFloat(String(b.valor_agregado).replace('%', '')) || 0;
          return aVal - bVal;
        }
        return 0;
      });
    
    console.log('getFilteredCambios() - Cambios filtrados:', filtered.length);
    if (filtered.length > 0) {
      console.log('Primeros cambios encontrados:', filtered.slice(0, 2).map(r => ({ codigo: r.codigo, fecha: r.fecha })));
    }
    
    return filtered;
  }
  function renderCambios(){ 
    console.log('renderCambios() INICIO');
    const all = getFilteredCambios(); 
    console.log(`renderCambios() - Total filtrados: ${all.length}`);
    const totalPages = Math.max(1, Math.ceil(all.length / pageSize)); 
    if (page > totalPages) page = totalPages; 
    const start = (page - 1) * pageSize; 
    const list = all.slice(start, start + pageSize);
    
    const tableContainer = document.querySelector('.overflow-x-auto');
    const noResultsDiv = document.getElementById('noResultsCambios');
    const noResultsText = document.getElementById('noResultsTextCambios');
    
    if (all.length === 0) {
      // No hay resultados - ocultar tabla y mostrar mensaje
      tableContainer.style.display = 'none';
      noResultsDiv.classList.remove('hidden');
      
      // Personalizar mensaje según el tipo de filtro activo
      if (q2.trim()) {
        noResultsText.textContent = `No hay resultados para "${q2.trim()}"`;
      } else if (Object.keys(columnFilters).length > 0) {
        noResultsText.textContent = 'No se encontraron procesos que coincidan con los filtros aplicados.';
      } else {
        noResultsText.textContent = 'No se encontraron procesos que coincidan con tu búsqueda.';
      }
      
      // Actualizar contador
      countCambios.textContent = '0 resultados';
      pageInfo.innerHTML = '';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
    } else {
      // Hay resultados - mostrar tabla y ocultar mensaje
      tableContainer.style.display = 'block';
      noResultsDiv.classList.add('hidden');
      
      tbodyCambios.innerHTML = list.map(rowCambios).join(''); 
      countCambios.textContent = all.length + ' resultado' + (all.length !== 1 ? 's' : ''); 
      
      // Generar botones de página individuales
      pageInfo.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = 'px-3 py-2 rounded-lg font-bold transition-all duration-200';
        
        if (i === page) {
          // Página actual - resaltada
          pageBtn.style.cssText = 'background-color: #121E6C; color: white; border: 2px solid #121E6C;';
        } else {
          // Páginas inactivas
          pageBtn.style.cssText = 'background-color: white; color: #121E6C; border: 2px solid #e2e8f0;';
          pageBtn.onmouseover = function() { this.style.backgroundColor = '#f1f5f9'; };
          pageBtn.onmouseout = function() { this.style.backgroundColor = 'white'; };
        }
        
        pageBtn.onclick = () => {
          page = i;
          renderCambios();
        };
        
        pageInfo.appendChild(pageBtn);
      }
      
      prevBtn.disabled = page <= 1; 
      nextBtn.disabled = page >= totalPages;
      
      // Agregar event listeners para tooltips de detalle con posicionamiento inteligente
      setTimeout(() => {
        document.querySelectorAll('.detalle-cell').forEach(cell => {
          const preview = cell.querySelector('.detalle-preview');
          const tooltip = cell.querySelector('.detalle-tooltip');
          
          if (preview && tooltip) {
            let isHovering = false;
            
            const showTooltip = (e) => {
              isHovering = true;
              
              // Obtener posición del preview
              const rect = preview.getBoundingClientRect();
              const viewportHeight = window.innerHeight;
              const tooltipHeight = 200; // Estimado
              
              // Decidir si mostrar arriba o abajo
              const spaceBelow = viewportHeight - rect.bottom;
              const spaceAbove = rect.top;
              
              tooltip.classList.remove('hidden');
              
              // Posicionar el tooltip
              if (spaceBelow < tooltipHeight && spaceAbove > spaceBelow) {
                // Mostrar arriba si no hay espacio abajo
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 8) + 'px';
              } else {
                // Mostrar abajo (default)
                tooltip.style.left = rect.left + 'px';
                tooltip.style.top = (rect.bottom + 8) + 'px';
              }
            };
            
            const hideTooltip = () => {
              isHovering = false;
              setTimeout(() => {
                if (!isHovering) {
                  tooltip.classList.add('hidden');
                }
              }, 100);
            };
            
            preview.addEventListener('mouseenter', showTooltip);
            preview.addEventListener('mouseleave', hideTooltip);
            
            // Mantener tooltip visible mientras el cursor está sobre él
            tooltip.addEventListener('mouseenter', () => {
              isHovering = true;
            });
            
            tooltip.addEventListener('mouseleave', hideTooltip);
          }
        });
      }, 50);
    }
    
    updateFilterIndicators();
  }
  
  // Función para actualizar indicadores visuales de filtros activos
  function updateFilterIndicators() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
      const column = btn.dataset.column;
      if (columnFilters[column] && columnFilters[column].length > 0) {
        btn.style.color = '#FF2947'; // coral para indicar filtro activo
      } else {
        btn.style.color = '#121E6C'; // color azul por defecto igual al header
      }
    });
  }
  document.getElementById('q2').addEventListener('input', (e) => { 
    q2 = e.target.value; 
    page = 1; 
    renderCambios(); 
  });
    
  document.getElementById('resetBtn2').addEventListener('click', () => {
    q2 = '';
    columnFilters = {};
    sort2 = 'va'; // Restaurar orden por VA descendente
    page = 1;
    
    document.getElementById('q2').value = '';
    
    renderCambios();
  });
  prevBtn.addEventListener('click',()=>{if(page>1){page--;renderCambios();}});
  nextBtn.addEventListener('click',()=>{page++;renderCambios();});

  // ======== NAVEGACIÓN LATERAL ========
  const sideNav = document.getElementById('sideNav');
  const heroNavButtons = document.getElementById('heroNavButtons');
  const sections = document.querySelectorAll('section[id]');
  const heroNavBtns = document.querySelectorAll('.hero-nav-btn');
  const sideNavBtns = document.querySelectorAll('#sideNav .side-nav-item');
  
  // Función para mostrar/ocultar navegación lateral Y selector flotante de fecha
  function toggleSideNav() {
    const floatMonthSelector = document.getElementById('floatMonthSelector');
    const heroRect = heroNavButtons.getBoundingClientRect();
    const shouldShowSideNav = heroRect.bottom < -50;
    
    if (shouldShowSideNav) {
      // Mostrar navegación lateral
      sideNav.classList.add('show');
      
      // Mostrar selector flotante de fecha
      if (floatMonthSelector) {
        floatMonthSelector.classList.remove('opacity-0', 'pointer-events-none', 'translate-x-full');
        floatMonthSelector.classList.add('opacity-100', 'pointer-events-auto', 'translate-x-0');
      }
    } else {
      // Ocultar navegación lateral
      sideNav.classList.remove('show');
      
      // Ocultar selector flotante de fecha
      if (floatMonthSelector) {
        floatMonthSelector.classList.add('opacity-0', 'pointer-events-none', 'translate-x-full');
        floatMonthSelector.classList.remove('opacity-100', 'pointer-events-auto', 'translate-x-0');
      }
    }
  }
  
  // Función para actualizar botón activo basado en posición de scroll
  function updateActiveNavButton() {
    let current = '';
    let closestDistance = Infinity;
    
    sections.forEach(section => {
      const sectionTop = section.getBoundingClientRect().top;
      const sectionBottom = section.getBoundingClientRect().bottom;
      const sectionHeight = sectionBottom - sectionTop;
      const sectionCenter = sectionTop + (sectionHeight / 2);
      
      // Si la sección está visible en el viewport
      if (sectionTop <= window.innerHeight && sectionBottom >= 0) {
        // Calcular la distancia al centro del viewport
        const viewportCenter = window.innerHeight / 2;
        const distanceToCenter = Math.abs(sectionCenter - viewportCenter);
        
        // Si esta sección está más cerca del centro, asignarla como activa
        if (distanceToCenter < closestDistance) {
          closestDistance = distanceToCenter;
          current = section.getAttribute('id');
        }
      }
      
      // También considerar si estamos en la parte superior de una sección
      if (sectionTop <= 150 && sectionTop > -100) {
        current = section.getAttribute('id');
      }
    });
    
    // Actualizar botones del hero
    heroNavBtns.forEach(btn => {
      const href = btn.getAttribute('href');
      if (href === `#${current}`) {
        btn.style.transform = 'scale(1.05)';
        btn.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
      } else {
        btn.style.transform = 'scale(1)';
        btn.style.boxShadow = '0 25px 50px -12px rgba(0, 0, 0, 0.25)';
      }
    });
    
    // Actualizar botones de navegación lateral
    sideNavBtns.forEach(btn => {
      const href = btn.getAttribute('href');
      if (href === `#${current}`) {
        btn.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
        btn.style.transform = 'scale(1.05)';
      } else {
        btn.style.backgroundColor = '';
        btn.style.transform = 'scale(1)';
      }
    });
  }
  
  // ======== BOTÓN VOLVER ARRIBA ========
  function scrollToTop() {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  }
  
  // Mostrar/ocultar botón flotante
  const scrollToTopFloat = document.getElementById('scrollToTopFloat');
  function toggleScrollButton() {
    if (!scrollToTopFloat) return; // Salir si el botón no existe
    
    if (window.pageYOffset > 300) {
      scrollToTopFloat.classList.remove('opacity-0', 'pointer-events-none');
      scrollToTopFloat.classList.add('opacity-100', 'pointer-events-auto');
    } else {
      scrollToTopFloat.classList.add('opacity-0', 'pointer-events-none');
      scrollToTopFloat.classList.remove('opacity-100', 'pointer-events-auto');
    }
  }
  
  // Escuchar scroll para navegación activa, side nav y botón flotante
  window.addEventListener('scroll', () => {
    toggleSideNav();
    updateActiveNavButton();
    toggleScrollButton();
    
    // Cerrar filtro dropdown si está abierto
    const dropdown = document.getElementById('filterDropdown');
    if (dropdown && !dropdown.classList.contains('hidden')) {
      hideFilterDropdown();
    }
  });
  
  // ======== LÓGICA DEL SELECTOR FLOTANTE DE FECHA ========
  
  // Variables temporales para el selector flotante (unificadas)
  let floatTempSelectedYear = currentSelectedYear;
  let floatTempSelectedMonth = currentSelectedMonth;
  
  // Elementos del selector flotante
  const floatMonthSelectorBtn = document.getElementById('floatMonthSelectorBtn');
  const floatMonthDropdown = document.getElementById('floatMonthDropdown');
  const floatSelectedMonth = document.getElementById('floatSelectedMonth');
  const floatYearSelectBtn = document.getElementById('floatYearSelectBtn');
  const floatMonthSelectBtn = document.getElementById('floatMonthSelectBtn');
  const floatYearDropdown = document.getElementById('floatYearDropdown');
  const floatMonthDropdownCustom = document.getElementById('floatMonthDropdownCustom');
  const confirmSelectionBtnFloat = document.getElementById('confirmSelectionBtn');
  
  // Función para actualizar la UI del selector flotante
  function updateFloatSelectorUI() {
    console.log('updateFloatSelectorUI() - Actualizando UI del selector flotante');
    console.log('Variables actuales:', { currentSelectedMonth, currentSelectedYear });
    
    if (!currentSelectedMonth || !currentSelectedYear || !monthNames) {
      console.error('Variables requeridas no definidas:', { currentSelectedMonth, currentSelectedYear, monthNames: !!monthNames });
      return;
    }
    
    const monthName = monthNames[currentSelectedMonth - 1];
    const display = `${monthName} ${currentSelectedYear}`;
    
    console.log('Display calculado:', display);
    console.log('floatSelectedMonth encontrado:', !!floatSelectedMonth);
    
    if (floatSelectedMonth) {
      floatSelectedMonth.textContent = display;
      console.log('✓ UI del selector flotante actualizada:', display);
    } else {
      console.error('✗ floatSelectedMonth no encontrado');
    }
  }
  
  // Función para mostrar/ocultar el dropdown del selector flotante
  function toggleFloatMonthDropdown() {
    if (!floatMonthDropdown) return;
    
    if (floatMonthDropdown.classList.contains('hidden')) {
      showFloatMonthDropdown();
    } else {
      hideFloatMonthDropdown();
    }
  }
  
  function showFloatMonthDropdown() {
    if (!floatMonthDropdown) return;
    
    console.log('showFloatMonthDropdown() - Abriendo dropdown flotante');
    console.log('Variables globales actuales:', { currentSelectedMonth, currentSelectedYear });
    
    // Inicializar variables temporales con valores actuales
    floatTempSelectedYear = currentSelectedYear;
    floatTempSelectedMonth = currentSelectedMonth;
    
    console.log('Variables temporales inicializadas:', { floatTempSelectedYear, floatTempSelectedMonth });
    
    // Poblar dropdowns
    populateFloatDropdowns();
    
    // Mostrar dropdown
    floatMonthDropdown.classList.remove('hidden');
    
    console.log('Dropdown flotante mostrado');
    
    // Agregar event listener para clics fuera del dropdown
    setTimeout(() => {
      document.addEventListener('click', handleFloatClickOutside);
    }, 100);
  }
  
  function hideFloatMonthDropdown() {
    if (!floatMonthDropdown) return;
    
    console.log('hideFloatMonthDropdown() - Ocultando dropdown flotante');
    
    // Ocultar dropdown principal
    floatMonthDropdown.classList.add('hidden');
    
    // Ocultar sub-dropdowns
    if (floatYearDropdown) floatYearDropdown.classList.add('hidden');
    if (floatMonthDropdownCustom) floatMonthDropdownCustom.classList.add('hidden');
    
    // Resetear todos los íconos a su estado inicial
    const floatYearDropIcon = document.getElementById('floatYearDropIcon');
    const floatMonthDropIcon = document.getElementById('floatMonthDropIcon');
    const floatMainDropIcon = document.getElementById('floatMonthDropdownIcon');
    
    if (floatYearDropIcon) floatYearDropIcon.style.transform = 'rotate(0deg)';
    if (floatMonthDropIcon) floatMonthDropIcon.style.transform = 'rotate(0deg)';
    if (floatMainDropIcon) floatMainDropIcon.style.transform = 'rotate(0deg)';
    
    // Remover event listener
    document.removeEventListener('click', handleFloatClickOutside);
  }
  
  // Función para manejar clics fuera del dropdown flotante
  function handleFloatClickOutside(event) {
    const floatMonthSelector = document.getElementById('floatMonthSelector');
    if (!floatMonthSelector?.contains(event.target)) {
      hideFloatMonthDropdown();
    }
  }
  
  // Función para poblar los dropdowns del selector flotante
  function populateFloatDropdowns() {
    populateFloatYearDropdown();
    populateFloatMonthDropdown();
  }
  
  function populateFloatYearDropdown() {
    console.log('populateFloatYearDropdown() - Poblando dropdown de años');
    const yearOptions = document.getElementById('floatYearOptions');
    const yearSelectedText = document.getElementById('floatYearSelectedText');
    const availableYears = getAvailableYears();
    
    console.log('Elementos encontrados:', { yearOptions: !!yearOptions, yearSelectedText: !!yearSelectedText });
    console.log('Años disponibles:', availableYears);
    console.log('Año temporal actual:', floatTempSelectedYear);
    
    if (!yearOptions || !yearSelectedText) {
      console.error('Elementos de año no encontrados');
      return;
    }
    
    yearOptions.innerHTML = '';
    yearSelectedText.textContent = floatTempSelectedYear;
    
    availableYears.forEach(year => {
      const option = document.createElement('div');
      option.className = `px-4 py-3 cursor-pointer transition-colors hover:bg-blue-50 ${
        year === floatTempSelectedYear ? 'font-bold' : 'font-medium'
      }`;
      option.style.color = year === floatTempSelectedYear ? '#121E6C' : '#374151';
      option.textContent = year;
      
      // Agregar event listener con debugging
      option.addEventListener('click', (e) => {
        console.log('CLICK en año:', year);
        e.preventDefault();
        e.stopPropagation();
        selectFloatYear(year);
      });
      
      yearOptions.appendChild(option);
    });
    
    console.log('Dropdown de años poblado con', availableYears.length, 'opciones');
  }
  
  function populateFloatMonthDropdown() {
    console.log('populateFloatMonthDropdown() - Poblando dropdown de meses');
    const monthOptions = document.getElementById('floatMonthOptions');
    const monthSelectedText = document.getElementById('floatMonthSelectedText');
    const availableMonths = getAvailableMonthsForYear(floatTempSelectedYear);
    
    console.log('Elementos encontrados:', { monthOptions: !!monthOptions, monthSelectedText: !!monthSelectedText });
    console.log('Meses disponibles para', floatTempSelectedYear, ':', availableMonths);
    console.log('Mes temporal actual:', floatTempSelectedMonth);
    
    if (!monthOptions || !monthSelectedText) {
      console.error('Elementos de mes no encontrados');
      return;
    }
    
    monthOptions.innerHTML = '';
    
    // Encontrar nombre del mes seleccionado
    const selectedMonthObj = availableMonths.find(m => m.number === floatTempSelectedMonth);
    const displayText = selectedMonthObj ? selectedMonthObj.name : 'Seleccionar...';
    monthSelectedText.textContent = displayText;
    
    console.log('Texto del botón mes actualizado a:', displayText);
    
    availableMonths.forEach(month => {
      const option = document.createElement('div');
      option.className = `px-4 py-3 cursor-pointer transition-colors hover:bg-blue-50 ${
        month.number === floatTempSelectedMonth ? 'font-bold' : 'font-medium'
      }`;
      option.style.color = month.number === floatTempSelectedMonth ? '#121E6C' : '#374151';
      option.textContent = month.name;
      
      // Agregar event listener con debugging
      option.addEventListener('click', (e) => {
        console.log('CLICK en mes:', month.name, '(', month.number, ')');
        e.preventDefault();
        e.stopPropagation();
        selectFloatMonth(month.number);
      });
      
      monthOptions.appendChild(option);
    });
    
    console.log('Dropdown de meses poblado con', availableMonths.length, 'opciones');
  }
  
  // Funciones de toggle para sub-dropdowns del selector flotante
  function toggleFloatYearDropdown() {
    if (!floatYearDropdown || !floatMonthDropdownCustom) return;
    
    const floatYearDropIcon = document.getElementById('floatYearDropIcon');
    const floatMonthDropIcon = document.getElementById('floatMonthDropIcon');
    
    // Cerrar dropdown de mes si está abierto
    floatMonthDropdownCustom.classList.add('hidden');
    if (floatMonthDropIcon) floatMonthDropIcon.style.transform = 'rotate(0deg)';
    
    if (floatYearDropdown.classList.contains('hidden')) {
      floatYearDropdown.classList.remove('hidden');
      if (floatYearDropIcon) floatYearDropIcon.style.transform = 'rotate(180deg)';
    } else {
      floatYearDropdown.classList.add('hidden');
      if (floatYearDropIcon) floatYearDropIcon.style.transform = 'rotate(0deg)';
    }
  }
  
  function toggleFloatMonthDropdownInternal() {
    if (!floatYearDropdown || !floatMonthDropdownCustom) return;
    
    const floatYearDropIcon = document.getElementById('floatYearDropIcon');
    const floatMonthDropIcon = document.getElementById('floatMonthDropIcon');
    
    // Cerrar dropdown de año si está abierto
    floatYearDropdown.classList.add('hidden');
    if (floatYearDropIcon) floatYearDropIcon.style.transform = 'rotate(0deg)';
    
    if (floatMonthDropdownCustom.classList.contains('hidden')) {
      floatMonthDropdownCustom.classList.remove('hidden');
      if (floatMonthDropIcon) floatMonthDropIcon.style.transform = 'rotate(180deg)';
    } else {
      floatMonthDropdownCustom.classList.add('hidden');
      if (floatMonthDropIcon) floatMonthDropIcon.style.transform = 'rotate(0deg)';
    }
  }
  
  // Funciones de selección temporal (no aplican cambios inmediatamente)
  function selectFloatYear(year) {
    console.log('selectFloatYear() - Seleccionando año:', year);
    floatTempSelectedYear = year;
    
    // Verificar si el mes actual está disponible en el nuevo año
    const availableMonths = getAvailableMonthsForYear(year);
    const monthNumbers = availableMonths.map(m => m.number);
    if (!monthNumbers.includes(floatTempSelectedMonth)) {
      floatTempSelectedMonth = monthNumbers[monthNumbers.length - 1]; // Seleccionar el último mes disponible
      console.log('Mes ajustado a:', floatTempSelectedMonth);
    }
    
    // Actualizar UI temporal - refrescar ambos dropdowns
    populateFloatDropdowns();
    
    // Cerrar SOLO el sub-dropdown de año (NO el dropdown principal)
    if (floatYearDropdown) {
      floatYearDropdown.classList.add('hidden');
      const floatYearDropIcon = document.getElementById('floatYearDropIcon');
      if (floatYearDropIcon) floatYearDropIcon.style.transform = 'rotate(0deg)';
    }
    
    // IMPORTANTE: NO llamar hideFloatMonthDropdown() aquí
    console.log('Variables temporales:', { floatTempSelectedYear, floatTempSelectedMonth });
    console.log('Dropdown principal mantiene abierto para confirmación');
  }
  
  function selectFloatMonth(monthNumber) {
    console.log('selectFloatMonth() - Seleccionando mes:', monthNumber);
    floatTempSelectedMonth = monthNumber;
    
    // Actualizar solo UI temporal del mes
    populateFloatMonthDropdown();
    
    // Cerrar SOLO el sub-dropdown de mes (NO el dropdown principal)
    if (floatMonthDropdownCustom) {
      floatMonthDropdownCustom.classList.add('hidden');
      const floatMonthDropIcon = document.getElementById('floatMonthDropIcon');
      if (floatMonthDropIcon) floatMonthDropIcon.style.transform = 'rotate(0deg)';
    }
    
    // IMPORTANTE: NO llamar hideFloatMonthDropdown() aquí
    console.log('Variables temporales:', { floatTempSelectedYear, floatTempSelectedMonth });
    console.log('Dropdown principal mantiene abierto para confirmación');
  }
  
  // FUNCIÓN PRINCIPAL: confirmSelection - Único punto de entrada para aplicar cambios
  function confirmSelection() {
    console.log('=== CONFIRMACIÓN DE SELECCIÓN FLOTANTE ===');
    console.log('Estado anterior:', { currentSelectedMonth, currentSelectedYear });
    console.log('Nuevo estado:', { floatTempSelectedMonth, floatTempSelectedYear });
    
    // Validar que tenemos valores temporales válidos
    if (!floatTempSelectedYear || !floatTempSelectedMonth) {
      console.error('Error: Variables temporales no definidas');
      return;
    }
    
    // Aplicar cambios a las variables globales
    currentSelectedMonth = floatTempSelectedMonth;
    currentSelectedYear = floatTempSelectedYear;
    
    console.log('Variables globales actualizadas:', { currentSelectedMonth, currentSelectedYear });
    
    // Actualizar UI del selector flotante
    updateFloatSelectorUI();
    
    // Ocultar dropdown
    hideFloatMonthDropdown();
    
    // Verificar que updateAllSections esté definida antes de llamarla
    if (typeof updateAllSections === 'function') {
      console.log('Ejecutando updateAllSections()...');
      updateAllSections();
      console.log('updateAllSections() completado');
    } else {
      console.error('Error: updateAllSections() no está definida');
      return;
    }
    
    console.log('✓ Selección aplicada exitosamente');
    
    // Verificación final
    setTimeout(() => {
      console.log('Verificación post-aplicación:');
      console.log('- Cards automatización:', document.getElementById('cards')?.children.length || 0);
      console.log('- Filas tabla cambios:', document.getElementById('tbodyCambios')?.children.length || 0);
      console.log('- Selector flotante muestra:', floatSelectedMonth?.textContent || 'N/A');
    }, 100);
  }
  
  // Event listeners para el selector flotante
  console.log('=== ENLAZANDO EVENT LISTENERS DEL SELECTOR FLOTANTE ===');
  
  if (floatMonthSelectorBtn) {
    floatMonthSelectorBtn.addEventListener('click', toggleFloatMonthDropdown);
    console.log('✓ Botón principal flotante enlazado');
  } else {
    console.error('✗ floatMonthSelectorBtn no encontrado');
  }
  
  if (floatYearSelectBtn) {
    floatYearSelectBtn.addEventListener('click', toggleFloatYearDropdown);
    console.log('✓ Botón selección año flotante enlazado');
  } else {
    console.error('✗ floatYearSelectBtn no encontrado');
  }
  
  if (floatMonthSelectBtn) {
    floatMonthSelectBtn.addEventListener('click', toggleFloatMonthDropdownInternal);
    console.log('✓ Botón selección mes flotante enlazado');
  } else {
    console.error('✗ floatMonthSelectBtn no encontrado');
  }
  
  if (confirmSelectionBtnFloat) {
    confirmSelectionBtnFloat.addEventListener('click', (e) => {
      console.log('=== CLICK EN APLICAR SELECCIÓN ===');
      e.preventDefault();
      e.stopPropagation();
      confirmSelection();
    });
    console.log('✓ Botón \'Aplicar Selección\' enlazado');
    
    // Test adicional: verificar que el botón sea clicable
    console.log('Botón \'Aplicar Selección\' es clicable:', !confirmSelectionBtnFloat.disabled);
    console.log('Botón \'Aplicar Selección\' está visible:', confirmSelectionBtnFloat.offsetParent !== null);
  } else {
    console.error('✗ confirmSelectionBtnFloat no encontrado - ¡CAUSA RAÍZ DEL PROBLEMA!');
  }
  
  console.log('=== EVENT LISTENERS FLOTANTES CONFIGURADOS ===');
  
  // ======== INICIALIZACIÓN DEL SISTEMA DE MES/AÑO ========
  // Event listener para el selector de mes principal
  const monthSelector = document.getElementById('monthSelector');
  if (monthSelector) {
    monthSelector.addEventListener('click', toggleMonthDropdown);
  } else {
    console.warn('monthSelector no encontrado');
  }
  
  // Event listener para el botón confirmar principal (si existe)
  const confirmSelectionBtn = document.getElementById('confirmSelection');
  if (confirmSelectionBtn) {
    confirmSelectionBtn.addEventListener('click', confirmSelection);
  } else {
    console.warn('confirmSelection no encontrado - continuando sin él');
  }
  
  // Inicializar mes por defecto
  initializeDefaultMonth();
  
  // Inicializar variables temporales después de establecer los valores actuales
  tempSelectedYear = currentSelectedYear;
  tempSelectedMonth = currentSelectedMonth;
  
  // Inicializar selector flotante
  console.log('=== INICIALIZANDO SELECTOR FLOTANTE ===');
  console.log('Variables globales disponibles:', { currentSelectedMonth, currentSelectedYear });
  
  floatTempSelectedYear = currentSelectedYear;
  floatTempSelectedMonth = currentSelectedMonth;
  
  console.log('Variables temporales inicializadas:', { floatTempSelectedYear, floatTempSelectedMonth });
  
  // Actualizar UI inicial
  updateFloatSelectorUI();
  
  console.log('=== SELECTOR FLOTANTE INICIALIZADO ===');
  
  // Función de diagnóstico para el selector flotante
  function debugFloatSelector() {
    console.log('=== DIAGNÓSTICO DEL SELECTOR FLOTANTE ===');
    console.log('Elementos encontrados:');
    console.log('- floatMonthSelector:', !!document.getElementById('floatMonthSelector'));
    console.log('- floatMonthSelectorBtn:', !!floatMonthSelectorBtn);
    console.log('- floatMonthDropdown:', !!floatMonthDropdown);
    console.log('- floatSelectedMonth:', !!floatSelectedMonth);
    console.log('- floatYearSelectBtn:', !!floatYearSelectBtn);
    console.log('- floatMonthSelectBtn:', !!floatMonthSelectBtn);
    console.log('- confirmSelectionBtnFloat:', !!confirmSelectionBtnFloat);
    console.log('- floatYearDropdown:', !!floatYearDropdown);
    console.log('- floatMonthDropdownCustom:', !!floatMonthDropdownCustom);
    console.log('Variables:');
    console.log('- currentSelected:', { currentSelectedMonth, currentSelectedYear });
    console.log('- floatTemp:', { floatTempSelectedMonth, floatTempSelectedYear });
    
    // TEST: Verificar que floatSelectedMonth muestre el texto correcto
    console.log('\n=== TEST DE UI ===');
    if (floatSelectedMonth) {
      console.log('Contenido actual del botón flotante:', floatSelectedMonth.textContent);
      
      // Ejecutar updateFloatSelectorUI() manualmente para test
      console.log('Ejecutando updateFloatSelectorUI() manualmente...');
      updateFloatSelectorUI();
      
      console.log('Contenido después de update:', floatSelectedMonth.textContent);
    }
    
    // Hacer disponible confirmSelection() para test manual desde consola
    console.log('\n=== PRUEBAS MANUALES DISPONIBLES ===');
    console.log('Para probar manualmente:');
    console.log('• testConfirmSelection() - Aplica selección actual');
    console.log('• testChangeMonth(8) o testChangeMonth(9) - Cambia mes directamente');
    console.log('• debugCurrentState() - Muestra estado actual');
    console.log('• simulateUserInteraction() - Simula interacción completa');
    console.log('• testDataChange() - Prueba cambios de datos paso a paso');
    
    // Funciones de prueba globales
    window.testConfirmSelection = confirmSelection;
    
    window.testChangeMonth = function(month) {
      console.log(`=== TEST: Cambiando a mes ${month} ===`);
      floatTempSelectedMonth = month;
      floatTempSelectedYear = 2025;
      console.log('Variables temporales:', { floatTempSelectedMonth, floatTempSelectedYear });
      console.log('Ejecutando confirmSelection()...');
      confirmSelection();
    };
    
    window.debugCurrentState = function() {
      console.log('=== ESTADO ACTUAL ===');
      console.log('Variables globales:', { currentSelectedMonth, currentSelectedYear });
      console.log('Variables temporales:', { floatTempSelectedMonth, floatTempSelectedYear });
      console.log('Texto del botón flotante:', document.getElementById('floatSelectedMonth')?.textContent);
      console.log('Total automatizaciones visibles:', document.getElementById('cards')?.children.length);
      console.log('Total filas tabla:', document.getElementById('tbodyCambios')?.children.length);
    };
    
    // Función para simular la interacción completa del usuario
    window.simulateUserInteraction = function() {
      console.log('=== SIMULANDO INTERACCIÓN COMPLETA DEL USUARIO ===');
      
      // 1. Abrir el dropdown (simular clic en botón principal)
      console.log('1. Abriendo dropdown...');
      showFloatMonthDropdown();
      
      // 2. Cambiar a agosto (simular clic en opción)
      console.log('2. Seleccionando agosto...');
      selectFloatMonth(8);
      
      // 3. Aplicar selección (simular clic en botón aplicar)
      console.log('3. Aplicando selección...');
      setTimeout(() => {
        confirmSelection();
      }, 500);
      
      console.log('Simulación iniciada. Revisa los logs en 1 segundo.');
    };
    
    // Función para verificar si los datos cambian correctamente
    window.testDataChange = function() {
      console.log('=== VERIFICANDO CAMBIOS DE DATOS ===');
      
      console.log('Estado inicial (debería ser septiembre):');
      debugCurrentState();
      
      setTimeout(() => {
        console.log('\nCambiando a agosto...');
        testChangeMonth(8);
        
        setTimeout(() => {
          console.log('\nEstado después de cambio (debería ser agosto):');
          debugCurrentState();
        }, 500);
      }, 1000);
    };
    
    console.log('===================================================');
  }
  
  console.log('=== INICIALIZACIÓN PRINCIPAL COMPLETADA ===');
  console.log('Variables finales:', { currentSelectedMonth, currentSelectedYear, tempSelectedMonth, tempSelectedYear });
  console.log('Selector flotante inicializado:', { floatTempSelectedMonth, floatTempSelectedYear });
  
  // Ejecutar diagnóstico
  setTimeout(debugFloatSelector, 300);
  
  // ======== FIN DEL SCRIPT PRINCIPAL ========
  toggleSideNav();
  updateActiveNavButton();
  
  // Verificación final del estado y corrección del selector flotante
  setTimeout(() => {
    console.log('✅ INICIALIZACIÓN EXITOSA - Proyecto listo!');
    console.log('Datos cargados automáticamente para:', document.getElementById('selectedMonth')?.textContent);
    
    // CORRECCIÓN FINAL: Forzar actualización del selector flotante
    console.log('=== CORRECCIÓN FINAL DEL SELECTOR FLOTANTE ===');
    const floatSelectedMonthCheck = document.getElementById('floatSelectedMonth');
    console.log('floatSelectedMonth encontrado en verificación final:', !!floatSelectedMonthCheck);
    console.log('Contenido actual:', floatSelectedMonthCheck?.textContent);
    
    if (floatSelectedMonthCheck && currentSelectedMonth && currentSelectedYear) {
      const monthName = monthNames[currentSelectedMonth - 1];
      const display = `${monthName} ${currentSelectedYear}`;
      floatSelectedMonthCheck.textContent = display;
      console.log('✓ CORRECCIÓN APLICADA - Selector flotante actualizado a:', display);
    } else {
      console.error('✗ No se pudo corregir el selector flotante');
    }
  }, 200);

  // ======== VA por Unidad de Negocio: imágenes fijas + lightbox ========
  const img1 = document.getElementById('img1');
  const img2 = document.getElementById('img2');

// === Drive helpers con Fallback ===
// Extrae el FILE_ID del link de compartir (termina en /view)
function extractDriveId(link){
  const m = link.match(/\/d\/([a-zA-Z0-9_-]+)/) || link.match(/[?&]id=([^&]+)/);
  return m ? m[1] : null;
}

// Intenta varios endpoints de Drive hasta que uno funcione
function setDriveImage(imgEl, shareLink){
  const id = extractDriveId(shareLink);
  if(!id){ console.warn('No se pudo extraer FILE_ID de:', shareLink); return; }

  // Orden de prueba (el 3 y 4 suelen ser los más robustos)
  const candidates = [
    `https://drive.google.com/uc?export=view&id=${id}`,
    `https://drive.google.com/uc?export=download&id=${id}`,
    `https://lh3.googleusercontent.com/d/${id}=s2000`,            // proxy de googleusercontent
    `https://drive.google.com/thumbnail?id=${id}&sz=w10000`      // thumbnail tamaño grande
  ];

  let idx = 0;
  function tryNext(){
    if(idx >= candidates.length){
      console.error('Ninguna URL de Drive funcionó para', shareLink);
      return;
    }
    const url = candidates[idx++];
    // asigna y, si hay error, intenta la siguiente
    imgEl.onerror = () => tryNext();
    imgEl.src = url;
    console.log('Probando URL Drive =>', url);
  }
  tryNext();
}
// Las imágenes se cargan automáticamente según el mes seleccionado

  // Lightbox (zoom)
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightboxImg');

  function openLightbox(src){
    if(!src) return;
    lightboxImg.src = src;
    lightbox.classList.remove('hidden');
    lightbox.classList.add('flex');
  }
  function closeLightbox(){
    lightbox.classList.add('hidden');
    lightbox.classList.remove('flex');
    lightboxImg.src = '';
  }

  img1?.addEventListener('click', ()=> openLightbox(img1.src));
  img2?.addEventListener('click', ()=> openLightbox(img2.src));
  lightbox?.addEventListener('click', closeLightbox);
  document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeLightbox(); });

  // ========== CARGA DE DATOS DESDE GOOGLE SHEETS ==========
  async function loadDataFromSheets() {
    try {
      if (!window.SheetsConnector) {
        console.error('❌ SheetsConnector no está cargado');
        return;
      }
      
      const data = await window.SheetsConnector.initializeData();
      
      if (data.success) {
        // Asignar datos a las variables globales
        rows = data.automatizaciones;
        cambios = data.procesos;
        
        // Solo reemplazar valueAddedImages si vienen datos del sheet
        if (data.valorAgregado && Object.keys(data.valorAgregado).length > 0) {
          valueAddedImages = data.valorAgregado;
          console.log('✅ Imágenes de Valor Agregado cargadas desde sheet:', Object.keys(valueAddedImages).length, 'períodos');
        } else {
          console.log('⚠️ Usando imágenes de valor agregado fallback (hardcoded)');
        }
        
        console.log('✅ Datos cargados:', rows.length, 'automatizaciones,', cambios.length, 'procesos');
        
        // Inicializar la interfaz con los nuevos datos
        initializeDefaultMonth();
        
        // IMPORTANTE: Actualizar variables temporales y UI del selector flotante con el mes real
        console.log('🔄 Actualizando selector flotante con mes real seleccionado...');
        floatTempSelectedYear = currentSelectedYear;
        floatTempSelectedMonth = currentSelectedMonth;
        updateFloatSelectorUI();
        populateFloatDropdowns();
        console.log('✅ Selector flotante actualizado:', { floatTempSelectedMonth, floatTempSelectedYear });
        
      } else {
        console.error('❌ Error cargando datos:', data.error);
        alert('⚠️ Error cargando datos desde Google Sheets.');
      }
    } catch (error) {
      console.error('❌ Error de conexión:', error);
      alert('⚠️ Error de conexión con Google Sheets.');
    }
  }

  // Ejecutar carga de datos cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadDataFromSheets);
  } else {
    // DOM ya está listo, ejecutar inmediatamente
    loadDataFromSheets();
  }

</script>

  </div><!-- End Main Content -->
  
  <!-- User Info Display (shown after login in header) -->
  <div id="userInfo" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
  
</body>
</html>
