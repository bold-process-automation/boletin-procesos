
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bolet√≠n de procesos - Arq. de Negocio</title>
  <link rel="icon" href="data:image/svg+xml,
  <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
    <text y='.9em' font-size='90'>üöÄ</text>
  </svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in{animation:fade .25s ease-out both}
    @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    .bar{transition:width .35s ease}
    .tab{background:#fff;color:#111827;border:1px solid #e5e7eb}
    .tab:hover{background:#f8fafc}
    .tab-active{background:#111827 !important;color:#fff !important;border-color:#111827 !important}
    th.sticky{position:sticky;top:0;background:#0f172a;color:#fff}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-white">
  <div class="mx-auto max-w-6xl p-6 md:p-10">
    <div class="flex items-center gap-3">
      <div class="text-white bg-indigo-600 rounded-xl p-2 text-xl">üìÑ</div>
      <h1 class="text-2xl md:text-4xl font-semibold tracking-tight">Bolet√≠n de procesos</h1>
    </div>
    <p class="text-slate-600 mt-2">Automatizaciones (VA) y Cambios de procesos (creaci√≥n/actualizaci√≥n).</p>

    <div class="mt-6 flex gap-2">
      <button id="tabAuto" class="tab rounded-xl px-4 py-2">Automatizaciones</button>
      <button id="tabCambios" class="tab rounded-xl px-4 py-2">Cambios de procesos</button>
      <button id="tabVAUN" class="tab rounded-xl px-4 py-2">Valor agregado por unidad de negocio</button>
    </div>


    <!-- ========== AUTOMATIZACIONES (TARJETAS) ========== -->
    <section id="viewAuto" class="mt-6">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="block text-xs text-slate-500 mb-1">Buscar</label>
          <div class="relative">
            <input id="q" type="text" placeholder="App, proceso, detalle, compa√±√≠a" class="pl-9 w-full rounded-xl border border-slate-300 h-10 px-3 outline-none focus:ring-2 focus:ring-indigo-300" />
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">üîé</span>
          </div>
        </div>
        <div class="md:col-span-2">
          <div class="flex flex-wrap gap-2 items-center">
            <span class="text-xs text-slate-500">Compa√±√≠a:</span>
            <button data-company="" class="company-btn bg-slate-200 text-slate-800 rounded-full px-3 py-1 text-sm">Todas</button>
            <span id="companyBadges" class="flex flex-wrap gap-2"></span>
          </div>
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">M√≠n. % VA</label>
          <input id="minVA" type="range" min="0" max="100" step="5" value="0" class="w-full">
          <div class="text-xs text-slate-600 text-right"><span id="minVAVal">0</span>%</div>
        </div>
        <div class="flex gap-2 justify-end">
          <button id="sortBtn" class="h-10 rounded-xl border px-3 text-sm bg-white border-slate-300 hover:bg-slate-50">Ordenar por % VA</button>
          <button id="resetBtn" class="h-10 rounded-xl px-3 text-sm border border-transparent hover:bg-slate-100">‚Üª Limpiar</button>
        </div>
      </div>
      <div id="cards" class="mt-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </section>

    <!-- ========== CAMBIOS (LISTADO) ========== -->
    <section id="viewCambios" class="mt-6 hidden">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="block text-xs text-slate-500 mb-1">Buscar</label>
          <div class="relative">
            <input id="q2" type="text" placeholder="C√≥digo, documento, due√±o, detalle" class="pl-9 w-full rounded-xl border border-slate-300 h-10 px-3 outline-none focus:ring-2 focus:ring-indigo-300" />
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">üîé</span>
          </div>
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">Tipo de cambio</label>
          <select id="tipoSel" class="w-full h-10 rounded-xl border border-slate-300 px-3">
            <option value="">Todos</option>
            <option>Creaci√≥n</option>
            <option>Actualizaci√≥n</option>
          </select>
        </div>
        <div class="flex gap-2 justify-end">
          <button id="sortBtn2" class="h-10 rounded-xl border px-3 text-sm bg-white border-slate-300 hover:bg-slate-50">Ordenar por Fecha</button>
          <button id="resetBtn2" class="h-10 rounded-xl px-3 text-sm border border-transparent hover:bg-slate-100">‚Üª Limpiar</button>
        </div>
      </div>
      <div class="mt-4 overflow-x-auto border border-slate-200 rounded-2xl">
        <table class="w-full text-sm">
          <thead>
            <tr>
              <th class="sticky px-3 py-2 text-left whitespace-nowrap sortable" data-key="codigo">
                C√≥digo <span class="sort-indicator" data-for="codigo"></span>
              </th>
              <th class="sticky px-3 py-2 text-left">Documento</th>
              <th class="sticky px-3 py-2 text-left whitespace-nowrap sortable" data-key="dueno">
                Due√±o <span class="sort-indicator" data-for="dueno"></span>
              </th>
              <th class="sticky px-3 py-2 text-left">Detalle</th>
              <th class="sticky px-3 py-2 text-left sortable" data-key="compania">
                Compa√±√≠a <span class="sort-indicator" data-for="compania"></span>
              </th>
              <th class="sticky px-3 py-2 text-left sortable" data-key="tipo">
                Tipo <span class="sort-indicator" data-for="tipo"></span>
              </th>
              <th class="sticky px-3 py-2 text-left sortable" data-key="fecha">
                Aprobaci√≥n <span class="sort-indicator" data-for="fecha"></span>
              </th>
              <th class="sticky px-3 py-2 text-left sortable" data-key="va">
                VA <span class="sort-indicator" data-for="va"></span>
              </th>
            </tr>
          </thead>
          
          <tbody id="tbodyCambios" class="bg-white"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between mt-3 text-xs text-slate-600">
        <div id="countCambios">0 resultados</div>
        <div class="flex gap-2">
          <button id="prevPage" class="rounded-md border px-2 py-1 bg-white border-slate-300 hover:bg-slate-50">¬´</button>
          <span id="pageInfo" class="px-1">1 / 1</span>
          <button id="nextPage" class="rounded-md border px-2 py-1 bg-white border-slate-300 hover:bg-slate-50">¬ª</button>
        </div>
      </div>
    </section>
    <!-- ========== VALOR AGREGADO POR UNIDAD DE NEGOCIO (IM√ÅGENES) ========== -->
<section id="viewVAUN" class="mt-6 hidden">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <figure class="rounded-2xl overflow-hidden border border-slate-200 bg-white">
      <div class="p-3 text-sm text-slate-600 border-b">
        Unidad de negocio ‚Äì Valor agregado (SAS)
      </div>
      <div class="p-3">
        <!-- Pega aqu√≠ la URL o ruta local de la imagen SAS -->
        <img id="img1" alt="Valor agregado SAS" class="w-full h-auto rounded-lg cursor-zoom-in">
      </div>
    </figure>

    <figure class="rounded-2xl overflow-hidden border border-slate-200 bg-white">
      <div class="p-3 text-sm text-slate-600 border-b">
        Unidad de negocio ‚Äì Valor agregado (CF)
      </div>
      <div class="p-3">
        <!-- Pega aqu√≠ la URL o ruta local de la imagen CF -->
        <img id="img2" alt="Valor agregado CF" class="w-full h-auto rounded-lg cursor-zoom-in">
      </div>
    </figure>
  </div>

  <!-- Modal/lightbox para ampliar -->
  <div id="lightbox" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
    <img id="lightboxImg" class="max-h-[90vh] max-w-[95vw] rounded-xl shadow-2xl">
  </div>
</section>

    <div class="mt-8 text-xs text-slate-500">

    </div>
  </div>

<script>
  function parseLocalDate(ymd){ const p=String(ymd||'').split('-').map(Number); return new Date(p[0]||1970,(p[1]||1)-1,p[2]||1); }
  function formatDate(ymd){ const d=parseLocalDate(ymd); return d.toLocaleDateString('es-CO',{day:'2-digit',month:'2-digit',year:'2-digit'}); }

  let rows = [{"aplicativo": "APPIAN", "aplicacion": "RPA Ciclo operativo ACH", "proceso": "OP-PR-022 Gesti√≥n de transferencias ACH", "detalle": "Cargue y descarga de transacciones en integra ACH y neurona para su posterior conciliaci√≥n ", "compania": "CF", "vaFinal": 70.0, "incrementoVA": 38.0, "fecha": "2025-08-06"}, {"aplicativo": "APPIAN", "aplicacion": "Gesti√≥n de planes de acci√≥n de RO", "proceso": "GR-PR-005 Elaboraci√≥n y Seguimiento a Planes de Acci√≥n de RO\nGR-PR-105 Elaboraci√≥n y Seguimiento a Planes de Acci√≥n de RO SAS", "detalle": "Creaci√≥n (Risk Manager) y seguimiento (responsables) a los planes de acci√≥n de RO", "compania": "SAS Y CF", "vaFinal": 100.0, "incrementoVA": 33.0, "fecha": "2025-08-05"}, {"aplicativo": "APPIAN", "aplicacion": "Gesti√≥n de eventos RO", "proceso": "GR-PR-006 Gesti√≥n de eventos de riesgo operacional\nGR-PR-106 Gesti√≥n de eventos de riesgo operacional SAS", "detalle": NaN, "compania": "SAS Y CF", "vaFinal": 80.0, "incrementoVA": 5.0, "fecha": "2025-08-05"}];
  const cambios = [{"codigo": "OP-PR-022", "documento": "Gesti√≥n de transferencias ACH", "dueno": "Cesar Miguel Izaguirre Sanchez", "detalle": "Inclusi√≥n de RPA Appian en las actividades que realizaba el Analista de Operaciones Financieras (Back) Bold.co SAS\nInclusi√≥n como output del proceso, el proceso OP-PR-036 Contabilizaci√≥n y conciliaci√≥n de Cash In y Cash Out", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-19", "valor_agregado": "70.45%"}, {"codigo": "OP-IN-030-05", "documento": "Instructivo Actualizaci√≥n Fuente de Adquirencia", "dueno": "Cesar Miguel Izaguirre Sanchez", "detalle": "Su objetivo es asegurar la adecuada actualizaci√≥n de la base de datos del √°rea de adquirencia mediante la inclusi√≥n de informaci√≥n consolidada, completa y precisa, en relaci√≥n con el origen de los datos y las fechas establecidas en cada uno de los archivos consolidados. Esto con el fin de reflejar los resultados obtenidos a nivel operativo y mostrarlos al √°rea de FinOps, generando valor a trav√©s de la visualizaci√≥n de datos.", "compania": "CF", "tipo": "Creaci√≥n", "fecha": "2025-08-27", "valor_agregado": "N/A"}, {"codigo": "OP-IN-030-06", "documento": "Instructivo Pago y liquidaci√≥n de Bold CF a Bold CO SAS", "dueno": "Cesar Miguel Izaguirre Sanchez", "detalle": "Su objetivo es validar correctamente el pago a BOLD CO SAS de los montos resultantes del cuadre operativo y la conciliaci√≥n de las franquicias para todos los tipos de procesamiento (dom√©stico e internacional), asegurando que las transacciones procesadas sean liquidadas por Bold CF a Bold CO SAS, a trav√©s de la liquidaci√≥n de Payouts, el traslado entre cuentas y la generaci√≥n de un informe al √°rea de tesorer√≠a respecto a la operaci√≥n.", "compania": "CF", "tipo": "Creaci√≥n", "fecha": "2025-08-27", "valor_agregado": "N/A"}, {"codigo": "OP-PR-033", "documento": "Ajustes de adquirencia", "dueno": "Cesar Miguel Izaguirre Sanchez", "detalle": "Inclusi√≥n de Appian\nAjuste general del proceso", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-04", "valor_agregado": "66.67%"}, {"codigo": "GM-PR-001", "documento": "Comunicaciones a clientes", "dueno": "Mar√≠a Paula Machado Pantoja", "detalle": "Se a√±ade actividad 21. \"Notificar los resultados de la campa√±a\"", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-20", "valor_agregado": "77.27%"}, {"codigo": "TH-PR-001", "documento": "Reclutamiento de personal", "dueno": "Lina Meza", "detalle": "Eliminaci√≥n de actividades correspondientes a convocatoria interna ya que est√°n dentro del proceso TH-PR-024 Cambio interno de rol\nAclaraci√≥n de actividades de prueba de pol√≠grafo para las distintas √°reas\nInclusi√≥n de actividades relacionadas al c√°lculo de acciones con Appian", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-08", "valor_agregado": "43.33%"}, {"codigo": "TH-PR-008", "documento": "Offboarding de personal", "dueno": "Lina Meza", "detalle": "Se eliminan las actividades correspondientes al rol Inventory Analyst\nAjuste general del flujo", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-08", "valor_agregado": "42.11%"}, {"codigo": "TH-PR-011", "documento": "Gesti√≥n programa ESOP", "dueno": "Lina Meza", "detalle": "Eliminaci√≥n de Carta como gestor de plan de acciones, ahora todo se visualiza en BambooHR y se gestionan con un m√≥dulo de Appian.\nCambio del nombre del proceso.", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-08", "valor_agregado": "93.10%"}, {"codigo": "TH-PR-012", "documento": "Liquidaci√≥n y pago de aportes", "dueno": "Lina Meza", "detalle": "Adici√≥n de la actividad 6. \"Conciliar planilla vs. Contabilidad\"", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-08", "valor_agregado": "45.45%"}, {"codigo": "TH-PR-024", "documento": "Cambio interno de rol", "dueno": "Lina Meza", "detalle": "Ajuste del proceso", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-12", "valor_agregado": "45.16%"}, {"codigo": "GF-IN-005-02", "documento": "Instructivo Generaci√≥n Informe IRL", "dueno": "Nicoll Albornoz Blanco", "detalle": "Inclusi√≥n de actividades de el Analista de Operaciones Financieras Senior Bold.co SAS relacionadas a la validaci√≥n de la reporter√≠a de microcr√©dito tarjeta\nInclusi√≥n de actividades de el Analista de Operaciones Financieras Bold.co SAS relacionadas a la validaci√≥n de la reporter√≠a de emisi√≥n\nAjuste de las actividades del responsable del reporte", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-19", "valor_agregado": "N/A"}, {"codigo": "GF-IN-005-03", "documento": "Instructivo Generaci√≥n Informe CFEN", "dueno": "Nicoll Albornoz Blanco", "detalle": "Ajuste de las actividades del responsable del reporte", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-19", "valor_agregado": "N/A"}, {"codigo": "GF-IN-030-01", "documento": "Instructivo conciliaci√≥n cobro y recaudo tarjeta de cr√©dito", "dueno": "Cesar Miguel Izaguirre Sanchez", "detalle": "Su objetivo es conciliar los pagos realizados por los clientes de microcr√©dito tarjeta a trav√©s de los medios habilitados contra los registros internos y contables.", "compania": "CF", "tipo": "Creaci√≥n", "fecha": "2025-08-19", "valor_agregado": "N/A"}, {"codigo": "GF-IN-030-02", "documento": "Instructivo control y seguimiento de cupos", "dueno": "Cesar Miguel Izaguirre Sanchez", "detalle": "Su objetivo es conciliar y validar la consistencia de los cupos de microcr√©dito tarjeta (aprobado, utilizado y disponible) entre los reportes, identificando y gestionando las diferencias hasta registrar en el ERP.", "compania": "CF", "tipo": "Creaci√≥n", "fecha": "2025-08-19", "valor_agregado": "N/A"}, {"codigo": "SI-PR-004", "documento": "Gesti√≥n de Compras", "dueno": "Erick Verbel Facouseh", "detalle": "Se reemplaza el rol \"√°rea encargada\" por \"√°rea solicitante\"", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-29", "valor_agregado": "12.50%"}, {"codigo": "SI-PR-006", "documento": "Selecci√≥n y creaci√≥n de terceros", "dueno": "Erick Verbel Facouseh", "detalle": "Se reemplaza el rol \"√°rea encargada\" por \"√°rea solicitante\"", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-29", "valor_agregado": "38.46%"}, {"codigo": "SI-PR-008", "documento": "Recolecci√≥n de activos fijos e implementos de trabajo en offboarding", "dueno": "Lina Meza", "detalle": "Ajuste general en las actividades del proceso", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-08", "valor_agregado": "33.33%"}, {"codigo": "LC-MA-006", "documento": "Manual Ejecuci√≥n Debida Diligencia Intensificada (DDI) CF", "dueno": "Vanessa Fajardo", "detalle": "Creaci√≥n del documento", "compania": "CF", "tipo": "Creaci√≥n", "fecha": "2025-08-29", "valor_agregado": "N/A"}, {"codigo": "LC-MA-007", "documento": "Manual Metodol√≥gico Matriz de Riesgos SARLAFT", "dueno": "Vanessa Fajardo", "detalle": "Creaci√≥n del documento", "compania": "CF", "tipo": "Creaci√≥n", "fecha": "2025-08-29", "valor_agregado": "N/A"}, {"codigo": "LC-MA-009", "documento": "Manual Metodolog√≠a Segmentaci√≥n de Riesgo Clientes", "dueno": "Vanessa Fajardo", "detalle": "Creaci√≥n del documento", "compania": "CF", "tipo": "Creaci√≥n", "fecha": "2025-08-29", "valor_agregado": "N/A"}, {"codigo": "SI-PO-002", "documento": "Pol√≠tica activos fijos y elementos de trabajo", "dueno": "Lina Meza", "detalle": "Se a√±ade pol√≠tica de cobertura para equipos en caso de accidentes de tr√°nsito ocurridos en horario laboral.\nSe especifica el procedimiento a seguir y los soportes a presentar en caso de robo de equipos.", "compania": "CF", "tipo": "Actualizaci√≥n", "fecha": "2025-08-08", "valor_agregado": "N/A"}, {"codigo": "OP-PR-169", "documento": "Cierre diario de turno para clientes master merchant SAS", "dueno": "Juan Camilo Salgado Mar√≠n", "detalle": "Su objetivo es garantizar el env√≠o oportuno y seguro del archivo diario de transacciones a comercios master merchant, consolidando la informaci√≥n correspondiente al cierre del turno, y asegurando que nuevos clientes reciban correctamente las instrucciones para el acceso al archivo.", "compania": "SAS", "tipo": "Creaci√≥n", "fecha": "2025-08-04", "valor_agregado": "16.67%"}, {"codigo": "GM-PR-101", "documento": "Comunicaciones a clientes SAS", "dueno": "Jacob Abadia Garcia", "detalle": "Se a√±ade actividad 21. \"Notificar los resultados de la campa√±a\"", "compania": "SAS", "tipo": "Actualizaci√≥n", "fecha": "2025-08-20", "valor_agregado": "77.27%"}, {"codigo": "TH-PR-108", "documento": "Offboarding de personal", "dueno": "Maria Fernanda Navia Rey", "detalle": "Se eliminan las actividades correspondientes al rol Inventory Analyst\nSe incluye la participaci√≥n del Sales Ops Analyst\nAjuste general del flujo", "compania": "SAS", "tipo": "Actualizaci√≥n", "fecha": "2025-08-04", "valor_agregado": "45.45%"}, {"codigo": "TH-PR-111", "documento": "Gesti√≥n programa ESOP", "dueno": "Maria Fernanda Navia Rey", "detalle": "Eliminaci√≥n de Carta como gestor de plan de acciones, ahora todo se visualiza en BambooHR y se gestionan con un m√≥dulo de Appian.\nCambio del nombre del proceso.", "compania": "SAS", "tipo": "Actualizaci√≥n", "fecha": "2025-08-04", "valor_agregado": "93.10%"}, {"codigo": "TH-PR-112", "documento": "Liquidaci√≥n y pago de aportes", "dueno": "Maria Fernanda Navia Rey", "detalle": "Adici√≥n de la actividad 6. \"Conciliar planilla vs. Contabilidad\"", "compania": "SAS", "tipo": "Actualizaci√≥n", "fecha": "2025-08-04", "valor_agregado": "45.45%"}, {"codigo": "TH-PR-124", "documento": "Cambio interno de rol SAS", "dueno": "Maria Fernanda Navia Rey", "detalle": "Ajuste del proceso", "compania": "SAS", "tipo": "Actualizaci√≥n", "fecha": "2025-08-11", "valor_agregado": "45.16%"}, {"codigo": "SI-PR-108", "documento": "Recolecci√≥n de activos fijos e implementos de trabajo en offboarding SAS", "dueno": "Maria Fernanda Navia Rey", "detalle": "Inclusi√≥n actividades de recolecci√≥n de activos fijos de manera presencial, y actividades de recolecci√≥n de activos fijos a domicilio.", "compania": "SAS", "tipo": "Actualizaci√≥n", "fecha": "2025-08-04", "valor_agregado": "52.17%"}, {"codigo": "LC-MA-106", "documento": "Manual Ejecuci√≥n Debida Diligencia Intensificada (DDI) SAS", "dueno": "Vanessa Fajardo", "detalle": "Creaci√≥n del documento", "compania": "SAS", "tipo": "Creaci√≥n", "fecha": "2025-08-29", "valor_agregado": "N/A"}, {"codigo": "LC-MA-107", "documento": "Documento Metodol√≥gico Matriz de Riesgos SAGRILAFT SAS", "dueno": "Vanessa Fajardo", "detalle": "Creaci√≥n del documento", "compania": "SAS", "tipo": "Creaci√≥n", "fecha": "2025-08-29", "valor_agregado": "N/A"}, {"codigo": "LC-MA-108", "documento": "Documento Metodol√≥gico Matriz de Riesgos PTEE (C/ST) - Programa de Transparencia y √âtica Empresarial SAS", "dueno": "Vanessa Fajardo", "detalle": "Creaci√≥n del documento", "compania": "SAS", "tipo": "Creaci√≥n", "fecha": "2025-08-29", "valor_agregado": "N/A"}, {"codigo": "LC-MA-109", "documento": "Manual Metodolog√≠a Segmentaci√≥n de Riesgo Clientes SAS", "dueno": "Vanessa Fajardo", "detalle": "Creaci√≥n del documento", "compania": "SAS", "tipo": "Creaci√≥n", "fecha": "2025-08-29", "valor_agregado": "N/A"}];
  

  const cardsEl = document.getElementById('cards');
  let query = '', company = '', minVA = 0, sortMode='fecha';
  const pctColor = (p)=> p>=100?'bg-emerald-500':p>=80?'bg-green-500':p>=50?'bg-amber-500':'bg-slate-300';
  const status = (p)=> p>=100?['¬°Listo!','bg-emerald-600 text-white']:p>=80?['Casi','bg-green-600 text-white']:['En curso','bg-slate-200 text-slate-800'];

  function renderCompanies(){ const set=[...new Set(rows.map(r=>r.compania))]; const wrap=document.getElementById('companyBadges'); wrap.innerHTML=''; set.forEach(c=>{ const b=document.createElement('button'); b.className='company-btn rounded-full px-3 py-1 text-sm bg-white border border-slate-300 hover:bg-slate-50'; b.textContent=c; b.dataset.company=c; wrap.appendChild(b);});}
  function renderAuto(){ const list=rows.filter(r=>!company||r.compania===company).filter(r=>Number(r.vaFinal)>=minVA).filter(r=>(r.aplicativo+' '+r.aplicacion+' '+r.proceso+' '+r.detalle+' '+r.compania).toLowerCase().includes(query.toLowerCase())).sort((a,b)=> sortMode==='fecha'?(parseLocalDate(b.fecha)-parseLocalDate(a.fecha)):(Number(b.vaFinal)-Number(a.vaFinal))); cardsEl.innerHTML=''; list.forEach(r=>{ const s=status(Number(r.vaFinal)); const lbl=s[0], cls=s[1]; const card=document.createElement('div'); card.className='fade-in rounded-2xl shadow-sm border border-slate-200 bg-white'; card.innerHTML='<div class="p-4 space-y-3"><div class="flex items-center justify-between"><span class="text-xs px-2 py-1 rounded-full border border-slate-300">'+(r.aplicativo||'')+'</span><span class="text-xs px-2 py-1 rounded-full bg-slate-900 text-white">'+(r.compania||'')+'</span></div><div class="font-semibold text-lg leading-snug">'+(r.aplicacion||'')+'</div><div class="text-sm text-slate-600">'+(r.proceso||'')+'</div><p class="text-sm text-slate-700 mt-1">'+(r.detalle||'')+'</p><div class="space-y-2"><div><div class="flex justify-between text-xs text-slate-500 mb-1"><span>% VA Final</span><span>'+Number(r.vaFinal) +'%</span></div><div class="h-2.5 bg-slate-100 rounded-full overflow-hidden"><div class="bar h-full '+pctColor(Number(r.vaFinal))+' rounded-full" style="width:'+Number(r.vaFinal)+'%"></div></div></div><div><div class="flex justify-between text-xs text-slate-500 mb-1"><span>Incremento VA</span><span>'+Number(r.incrementoVA)+'%</span></div><div class="h-2 bg-slate-100 rounded-full overflow-hidden"><div class="bar h-full bg-sky-500 rounded-full" style="width:'+Number(r.incrementoVA)+'%"></div></div></div></div><div class="flex items-center justify-between pt-2"><div class="text-xs text-slate-500">üìÖ Salida a prod.: <span class="font-medium text-slate-700">'+formatDate(r.fecha)+'</span></div><span class="text-xs px-2 py-1 rounded-full '+cls+'">'+lbl+'</span></div></div>'; cardsEl.appendChild(card); }); document.querySelectorAll('.company-btn').forEach(btn=>{ ((btn.dataset.company||'')===company) ? btn.classList.add('ring-2','ring-slate-400') : btn.classList.remove('ring-2','ring-slate-400');});}
  document.getElementById('q').addEventListener('input',(e)=>{query=e.target.value;renderAuto();});
  document.getElementById('minVA').addEventListener('input',(e)=>{minVA=+e.target.value;document.getElementById('minVAVal').textContent=minVA;renderAuto();});
  document.getElementById('sortBtn').addEventListener('click',()=>{sortMode=sortMode==='fecha'?'va':'fecha';document.getElementById('sortBtn').textContent=sortMode==='fecha'?'Ordenar por % VA':'Ordenar por Fecha';renderAuto();});
  document.getElementById('resetBtn').addEventListener('click',()=>{query='';company='';minVA=0;sortMode='fecha';document.getElementById('q').value='';document.getElementById('minVA').value=0;document.getElementById('minVAVal').textContent='0';renderAuto();});
  document.addEventListener('click',(e)=>{const b=e.target.closest('.company-btn');if(b){company=b.dataset.company||'';renderAuto();}});

  // ======== CAMBIOS ‚Äî listado con paginaci√≥n ========
  const tbodyCambios=document.getElementById('tbodyCambios');
  const countCambios=document.getElementById('countCambios');
  const pageInfo=document.getElementById('pageInfo');
  const prevBtn=document.getElementById('prevPage');
  const nextBtn=document.getElementById('nextPage');
  let q2='', tipoSel='', page=1, pageSize=10;

// --- Orden de tabla Cambios ---
let sortKey = 'fecha';   // columna activa por defecto
let sortDir = 'desc';    // 'asc' o 'desc'

// Valor normalizado por columna para comparar
function valueForSort(r, key){
  switch (key) {
    case 'va': {
      const v = r.valor_agregado;
      if (!v || String(v).trim() === '' || String(v).toUpperCase() === 'N/A') return -Infinity; // "No aplica" al fondo
      return parseFloat(String(v).replace('%','').replace(',','.'));
    }
    case 'fecha':
      return parseLocalDate(r.fecha).getTime();
    case 'codigo':
      return r.codigo || '';
    case 'dueno':
      return r.dueno || '';
    case 'compania':
      return r.compania || '';
    case 'tipo':
      return r.tipo || '';
    default:
      return r[key] || '';
  }
}

// Aplica el orden a una lista ya filtrada
function sortList(list){
  return list.sort((a, b) => {
    const va = valueForSort(a, sortKey);
    const vb = valueForSort(b, sortKey);
    if (typeof va === 'number' && typeof vb === 'number') {
      return sortDir === 'asc' ? va - vb : vb - va;
    }
    const res = String(va).localeCompare(String(vb), 'es', { numeric: true, sensitivity: 'base' });
    return sortDir === 'asc' ? res : -res;
  });
}

// Flechita ‚ñ≤‚ñº en header activo
function updateSortIndicators(){
  document.querySelectorAll('.sort-indicator').forEach(s => s.textContent = '');
  const active = document.querySelector(`.sort-indicator[data-for="${sortKey}"]`);
  if (active) active.textContent = sortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
}

  function rowCambios(r){
  const tipoClass = r.tipo === 'Creaci√≥n'
    ? 'bg-indigo-50 text-indigo-700 border border-indigo-200'
    : 'bg-amber-50 text-amber-700 border border-amber-200';
    const va = (!r.valor_agregado || String(r.valor_agregado).trim() === '' || String(r.valor_agregado).toUpperCase() === 'N/A')
  ? 'No aplica'
  : r.valor_agregado;

  return `
    <tr class="border-b border-slate-100 hover:bg-slate-50">
      <!-- C√≥digo: no-wrap, ocupa lo justo -->
      <td class="px-3 py-2 font-medium text-slate-800 whitespace-nowrap">${r.codigo}</td>

      <!-- Documento: lo dejas como lo ten√≠as -->
      <td class="px-3 py-2">${r.documento || ''}</td>

      <!-- Due√±o: no-wrap, pero con elipsis para no empujar columnas; tooltip con el nombre completo -->
      <td class="px-3 py-2 whitespace-nowrap overflow-hidden text-ellipsis max-w-[18ch]" title="${r.dueno || ''}">
        ${r.dueno || ''}
      </td>

      <td class="px-3 py-2 text-slate-700">${r.detalle || ''}</td>
      <td class="px-3 py-2">${r.compania || ''}</td>
      <td class="px-3 py-2">
        <span class="text-xs px-2 py-1 rounded-full ${tipoClass}">${r.tipo}</span>
      </td>
      <td class="px-3 py-2">${formatDate(r.fecha)}</td>
      <td class="px-3 py-2">${va}</td>
    </tr>
  `;
}
function getFilteredCambios(){
  const base = cambios
    .filter(r => !tipoSel || r.tipo === tipoSel)
    .filter(r =>
      (r.codigo + ' ' + r.documento + ' ' + (r.dueno||'') + ' ' + (r.detalle||'') + ' ' + (r.compania||'') + ' ' + (r.valor_agregado||''))
        .toLowerCase()
        .includes(q2.toLowerCase())
    );
  return sortList(base);
}

  function renderCambios(){ const all=getFilteredCambios(); const totalPages=Math.max(1, Math.ceil(all.length/pageSize)); if(page>totalPages) page=totalPages; const start=(page-1)*pageSize; const list=all.slice(start,start+pageSize); tbodyCambios.innerHTML=list.map(rowCambios).join(''); countCambios.textContent=all.length+' resultado'+(all.length!==1?'s':''); pageInfo.textContent=page+' / '+totalPages; prevBtn.disabled=page<=1; nextBtn.disabled=page>=totalPages; }
  document.getElementById('q2').addEventListener('input',(e)=>{q2=e.target.value;page=1;renderCambios();});
  document.getElementById('tipoSel').addEventListener('change',(e)=>{tipoSel=e.target.value;page=1;renderCambios();});
  document.getElementById('sortBtn2').addEventListener('click',()=>{sort2=sort2==='fecha'?'codigo':'fecha';document.getElementById('sortBtn2').textContent=sort2==='fecha'?'Ordenar por Fecha':'Ordenar por C√≥digo';page=1;renderCambios();});
  document.querySelectorAll('th.sortable').forEach(th => {
  th.style.cursor = 'pointer';
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    if (!key) return;

    if (sortKey === key) {
      sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
    } else {
      sortKey = key;
      // Por defecto: VA y Fecha en descendente; texto en ascendente
      sortDir = (key === 'va' || key === 'fecha') ? 'desc' : 'asc';
    }
    page = 1;
    updateSortIndicators();
    renderCambios();
  });
});


  // ======== TABS ========
  const tabAuto=document.getElementById('tabAuto');
  const tabCambios=document.getElementById('tabCambios');
  const viewAuto=document.getElementById('viewAuto');
  const viewCambios=document.getElementById('viewCambios');
  const tabVAUN = document.getElementById('tabVAUN');
  const viewVAUN = document.getElementById('viewVAUN');
  function activate(tab){
  // Quitar activo / ocultar todo
  tabAuto.classList.remove('tab-active');
  tabCambios.classList.remove('tab-active');
  tabVAUN.classList.remove('tab-active');

  viewAuto.classList.add('hidden');
  viewCambios.classList.add('hidden');
  viewVAUN.classList.add('hidden');

  if (tab === 'auto') {
    tabAuto.classList.add('tab-active');
    viewAuto.classList.remove('hidden');
  } else if (tab === 'cambios') {
    tabCambios.classList.add('tab-active');
    viewCambios.classList.remove('hidden');
  } else { // 'vaun'
    tabVAUN.classList.add('tab-active');
    viewVAUN.classList.remove('hidden');
  }
}
  tabAuto.addEventListener('click',()=>activate('auto'));
  tabCambios.addEventListener('click',()=>activate('cambios'));
  tabVAUN.addEventListener('click', ()=>activate('vaun'));

  // // Init
  activate('auto');
  renderCompanies();
  renderAuto();
  renderCambios();
  updateSortIndicators();


  // ======== VA por Unidad de Negocio: im√°genes fijas + lightbox ========
  const img1 = document.getElementById('img1');
  const img2 = document.getElementById('img2');

// === Drive helpers con Fallback ===
// Extrae el FILE_ID del link de compartir (termina en /view)
function extractDriveId(link){
  const m = link.match(/\/d\/([a-zA-Z0-9_-]+)/) || link.match(/[?&]id=([^&]+)/);
  return m ? m[1] : null;
}

// Intenta varios endpoints de Drive hasta que uno funcione
function setDriveImage(imgEl, shareLink){
  const id = extractDriveId(shareLink);
  if(!id){ console.warn('No se pudo extraer FILE_ID de:', shareLink); return; }

  // Orden de prueba (el 3 y 4 suelen ser los m√°s robustos)
  const candidates = [
    `https://drive.google.com/uc?export=view&id=${id}`,
    `https://drive.google.com/uc?export=download&id=${id}`,
    `https://lh3.googleusercontent.com/d/${id}=s2000`,            // proxy de googleusercontent
    `https://drive.google.com/thumbnail?id=${id}&sz=w10000`      // thumbnail tama√±o grande
  ];

  let idx = 0;
  function tryNext(){
    if(idx >= candidates.length){
      console.error('Ninguna URL de Drive funcion√≥ para', shareLink);
      return;
    }
    const url = candidates[idx++];
    // asigna y, si hay error, intenta la siguiente
    imgEl.onerror = () => tryNext();
    imgEl.src = url;
    console.log('Probando URL Drive =>', url);
  }
  tryNext();
}
// Pega tus links de "Obtener v√≠nculo" (los que terminan en /view)
setDriveImage(img1, "https://drive.google.com/file/d/1ZbS5WyojhMcdcZz5TINSL2yGTxwQbskb/view"); // SAS
setDriveImage(img2, "https://drive.google.com/file/d/1fUxaxuNvT5EdzAai_NvUL773Qq_mjk2O/view"); // CF

// (temporal) para depurar, ver la URL final en consola
console.log('img1 URL =>', img1.src);
console.log('img2 URL =>', img2.src);

  // Lightbox (zoom)
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightboxImg');

  function openLightbox(src){
    if(!src) return;
    lightboxImg.src = src;
    lightbox.classList.remove('hidden');
    lightbox.classList.add('flex');
  }
  function closeLightbox(){
    lightbox.classList.add('hidden');
    lightbox.classList.remove('flex');
    lightboxImg.src = '';
  }

  img1?.addEventListener('click', ()=> openLightbox(img1.src));
  img2?.addEventListener('click', ()=> openLightbox(img2.src));
  lightbox?.addEventListener('click', closeLightbox);
  document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeLightbox(); });

</script>
</body>
</html>
